---
title: OS-文件管理
date: 2022-03-04 08:57:15
tags: 
    - OS
    - 面试
mathjax: true
categories: OS
---

**操作系统文件管理重要知识总结**

<!--more-->

# 4 文件管理

## 4.1 文件系统基础

### 文件的概念

- 文件是以计算机硬盘为载体的存储在计算机上的信息集合
- 在系统运行时，计算机以**进程**为基本单位进行**资源的调度和分配**，在用户进行的**输入、输出**中，则**以文件为基本单位**

- 文件的**属性**：名称、标识符、类型、位置、大小、保护、时间

#### 文件操作

- 文件的**基本操作**：**创建**文件、**写**文件、**读**文件、文件**重定位**、**删除**文件、**截断**文件
- 使用**系统调用**`open()`打开文件，通常**返回一个指针**，以指向**打开文件表的**对应条目
- 操作系统通常采用**两级**的内部表：**每个进程表、整个系统表**
  - 每个进程表存储进程对文件的使用信息，跟踪它打开的所有文件，**进程表的条目指向**相应的整个**系统表的条目**
  - 整个系统表包含与进程无关的信息，为每个文件关联一个**打开计数**，表示打开该文件的进程数，进程调用`open()`时计数加1，调用`close()`时计数减1，当**计数为0**时表示不再使用该文件，系统表可以**删除该文件的条目**

- 文件的关联信息
  - **文件指针**，跟踪当前读写文件的位置，存储在每个进程表
  - **文件打开计数**，指当前打开文件的进程数，存储在系统表，若计数值为0该条目可从系统表移除
  - **文件的磁盘位置**
  - **访问权限**，每个进程采用访问模式打开文件，如可读可写或只读，保存在进程表

- 文件锁
  - **共享锁**类似于读者锁，多个进程可以并发地获取它
  - **独占锁**类似于写者锁，一次只有一个进程可以获取该锁
  - **强制**或**建议**文件锁定机制，**强制**锁定机制下**操作系统将保证**锁定完整性，**建议**锁定机制下**开发人员必须保证**锁定完整性

#### 内部文件结构

- 磁盘系统通常有明确定义的**块大小**，是由**扇区大小**决定的，所有**磁盘I/O**按**块为单位**执行，所有块的大小相同
- 逻辑记录大小、物理块大小和打包技术决定了每个物理块可有多少逻辑记录，所有文件系统都具有**内部碎片**（内存分配也存在碎片问题）

### 文件的逻辑结构

- 文件的逻辑结构，指**从用户观点**出发看到的**文件组织形式**
- **无结构文件（流式文件）**，数据按**顺序组织**成记录并积累、保存，是有序相关信息项的集合，以**字节为单位**

- 有结构文件按记录的组织形式可分为
  - **顺序文件**，记录按顺序排列，**记录**通常是**定长**的，访问时需要顺序搜索文件，顺序文件有两种结构
    - **串结构**，由时间决定顺序
    - **顺序结构**，按关键字顺序排列
  - **索引文件**，对于**变长记录文件**，建立**索引表**加快检索速度，**索引表本身是定长记录的顺序文件**，表项由索引号、长度、指向文件某个记录的指针组成
  - **索引顺序文件**，顺序文件**分为若干组**，为顺序文件建立索引表，索引表中**每组的第一条记录**建立一个**索引项**。**提高查找效率，但索引表增加了存储空间**
  - **直接文件或散列文件**

### 目录结构

#### 文件控制块

- **文件控制块FCB**是用来存放控制文件需要的各种信息的数据结构
  - **基本信息**，文件名、文件物理位置、文件逻辑结构、文件物理结构
  - **存取控制信息**，文件存取权限
  - **使用信息**，文件建立时间、修改时间

#### 索引节点

- 在**检索目录文件**的过程中只用到了**文件名**，只有当找到匹配的目录项时才需要取出**文件的物理地址**，因此检索目录时不需要文件的其他描述信息
- 因此，可以将**目录**和**文件描述信息分开**的方法，**文件描述信息**单独形成一个称为**索引节点**的数据结构，称为inode
- **文件目录**中的每个目录项仅由**文件名**和**指向该文件所对应的inode的指针**构成

#### 目录结构

- 在目录层次的文件操作
  - **搜索**，需要搜索目录以找到匹配的目录项
  - **创建文件**，添加一个新的目录项
  - **删除文件**，删除对应的目录项
  - **显示目录**
  - **修改目录**

- **单级**目录结构
  - 按**文件名**在该目录中查找相应的**FCB**
- **两级**目录结构：**主文件目录、用户文件目录**
  - **主文件目录项**记录**用户名**及相应用户文件目录所在位置
  - **用户文件目录项**记录该用户文件的**FCB信息**

- **多级目录**结构（树形目录结构）
  - 用**文件的路径名**标识文件，需要按路径名逐级访问中间节点，增加了磁盘访问次数
- **无环图**目录结构
  - 在树形目录结构基础上，增加指向同一节点的有向边，形成有向无环图，便于**文件共享**
  - 每个**共享节点**都需要设置**共享计数器**，**增加**该节点的共享链时**计数器加1**，用户**删除**该节点时**计数器减1**，仅当共享**计数器为0时**才**真正删除**节点

### 文件共享

#### 基于索引节点的共享方式（硬链接）

- 树形结构目录中，当有两个或多个用户共享一个文件时，将共享文件**链接**到两个或多个**用户的目录**中
- **文件目录**中只设置**文件名**及指向相应**索引节点的指针**，索引节点包括一个**链接计数**
  - **用户**创建文件时，索引节点**链接计数为1**
  - 用户往其目录**添加目录项**，并设置指针指向该索引节点时，**链接计数加1**
  - 用户想要**删除**文件时，如果链接计数为1，说明自己是**唯一的用户**，因此可以**删除该索引节点**；否则，**不能删除索引节点**，只是删除自己文件目录中的表项，该索引节点的**链接计数减1**

#### 利用符号链实现文件共享（软链接）

- 用户B共享用户A的一个文件F（F1）时，创建一个**LINK类型的新文件**，取名为F（F2），将文件F（F2）**写入用户B的目录**，该文件中只包含被链接文件F（F1）的**路径名**，这样的链接方法称为**符号链接**

- 因此**文件拥有者删除文件**后，其他共享该文件的用户通过**符号链**访问时，会**访问失败**，并将符号链删除，**不会出错**
- **硬链接**就是**多个指针**指向一个索引节点，**软链接**就是把到达共享文件的路径记录下来，访问文件时根**据路径寻找文件**，因此硬链接的查找速度更快

### 文件保护

- 文件保护措施包括**口令保护、加密保护和访问控制**
- 文件的访问类型包括：读、写、执行、添加、删除、列表清单

- **访问控制**，根据用户身份进行控制，每个文件和目录都增加一个访问控制列表，规定每个用户名及其所允许的访问类型
- **精简的访问列表**，拥有者、组、其他用户
  - **拥有者**是创建文件的用户
  - **组**是需要共享文件且具有类型访问的用户（与创建者位于同组的其他用户都能访问该文件）
  - **其他**是系统内的所有其他用户

- 口令、密码是另外两种访问控制方法
  - **口令**指创建者提供一个口令，并把该口令告诉共享文件的其他用户。用户**访问文件**时必须**输入相同的口令**
  - **密码**是用户对文件进行**加密**，文件被访问时需要使用**密钥**

## 4.2 文件系统实现

### 文件系统层次结构

- 用户调用接口
- 文件目录系统
- 存取控制验证模块
- 逻辑文件系统与文件信息缓冲区
- 物理文件系统
- 辅助分配模块
- 设备管理程序模块
- 记忆：**用户请求访问文件时会发生的事**
  - 通过**系统调用**请求访问文件（用户调用接口），操作系统在**目录中查找**该文件，得到FCB或索引节点（文件目录系统），根据FCB信息判断用户是否具有**访问权限**（存取控制验证模块），获取文件的**逻辑地址**（逻辑文件系统与文件信息缓冲区），将逻辑地址转换为**物理地址**（物理文件系统），完成寻址后我们可以管理该空间，可以**释放空间**（辅助分配模块）或**将其分配给设备用于I/O**（设备管理程序模块）

### 目录实现

- **线性列表**，使用存储文件名和数据块指针的线性表，查找的时间复杂度是$O(N)$
- **哈希表**，根据文件名得到一个值，返回一个指向线性列表中元素的指针，查找的平均时间复杂度是$O(1)$

### 文件实现——文件分配方式

- 文件实现是研究文件的**物理结构**，即文件**数据在物理存储设备上如何分布和组织**的问题

- **连续分配**，支持顺序访问、直接访问
- **链接分配**
  - 隐式链接，next指针，只支持顺序访问
  - 显式链接，每个磁盘维护文件分配表FAT，表项为<块号、文件下一块的块号>，特殊块号（如-1）标记文件末尾，特殊块号（如-2）标记空闲块，支持直接访问，但是FAT占用存储空间
- **索引分配**
  - 每个文件维护一个索引块，文件目录包含索引块的地址
  - 索引块的第i个条目指向文件的第i块，因此可以实现直接访问
  - 但是索引块增加了存储空间的开销
  - 索引块空间有限，**存储大文件**时，可通过将**多个索引块链接**起来、**多层索引**等形式实现

### 文件实现——文件存储空间分配

- **文件存储设备管理**实质上是对**空闲块**管理
- 略

## 4.3 磁盘组织和管理

### 磁盘结构

- **磁盘**
- **磁道**，一组同心圆
- **扇区**，磁道划分为若干扇区，每个扇区为一块，扇区是磁盘可寻址的最小存储单元
- **磁头**

### 磁盘调度算法

- 读写磁盘块的时间包括

  - **寻道时间**，制动手臂移动使得**磁头移动到适当的磁道上**
  - **旋转时间**，主轴转动盘面使得**磁头移动到适当的扇区上**
  - 实际的**数据传输时间**

  **寻道时间最长**，磁盘调度的主要目标是使磁盘的平均寻道时间最短

- **先来先服务**，按照磁盘请求的顺序进行调度，未对寻道时间 优化
- **最短寻道时间优先**，优先调度**与当前磁头所在磁道距离最近的磁道**，缺点是**不公平**，最外层和最里层的磁道更容易出现**“饥饿”**
- **扫描（SCAN）算法**，磁头总是**保持一个方向运行**，直到该方向没有请求位置，然后**改变移动方向**

