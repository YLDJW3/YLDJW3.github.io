---
title: 计网-链路层
date: 2022-02-28 14:31:53
tags: 
    - Computer Network
    - 面试
mathjax: true
categories: Computer Network
---

 **计网链路层重要知识总结**

<!--more-->

# 第6章 链路层和局域网

- 两种截然不同类型的链路层信道：**广播信道**、**点对点通信链路**

## 6.1 链路层概述

- 节点
- 链路
- 链路层帧

### 6.1.1 链路层提供的服务

- **成帧**
- **链路接入**
- **可靠交付**
- **差错检测和纠正**

### 6.1.2 链路层在何处实现

- **路由器**：链路层是实现在路由器的**线路卡**中的
- **主机**
  - 链路层的主体部分是在**网络适配器**中实现的，核心是**链路层控制器**，是一个实现了许多链路层服务的专用芯片，即链路层许多功能是**硬件实现**的
  - 部分链路层运行于主机**CPU上的软件**，实现了**高层链路层功能**
  - 因此，链路层是**硬件和软件的结合体**

## 6.2 差错检测和纠正技术

- 检测差错的3种技术：**奇偶校验**（描述差错检测和纠正背后隐含的基本思想）、**检验和方法**（通常更多地应用于运输层）、**循环冗余检测**（通常更多地应用在适配器中的链路层）

### 6.2.1 奇偶校验

- **奇校验、偶校验**
- 奇偶校验位，只能**检测奇数个**比特差错，**无法纠正**
- **二维奇偶校验方案**：奇偶校验的二维一般化方案，对数据D中的d个比特划分为$i$行$j$列，按**每行每列**计算奇偶校验位，产生$i+j+1$个奇偶比特
  - 能够**检测并纠正**数据D的**单个比特错误**
  - 能够检测并纠正**奇偶比特**的单个比特错误
  - 能够**检测**数据D中的**两个比特差错**，但**不能纠正**
- 使用二维奇偶校验方案，**接收方**具有的**纠正差错**的能力称为**前向纠错FEC**

### 6.2.2 检验和方法

- **检验和**：$d$比特数据被看作一个$k$比特整数的序列处理，将多个$k$比特整数相加，得到的和作为差错检测比特
- **因特网检验和**
  - **发送方**：将数据的每**字节**作为一个**16bit的整数**对待并**求和**，和的**反码**形成报文段首部的**因特网校验和**字段
  - **接收方**：通过对接收的**数据**（包括检验和）**的和取反码**，检测其结果**是否为全1比特**来检测检验和
- 检验和方法，只需要相对较小的分组开销，提供了相对较弱的差错保护
- 为什么**运输层**采用**检验和**，**链路层**采用**循环冗余检测CRC**？
  - **运输层**的差错检测采用**软件实现**，**检验和简单而快速**的特点适合运输层
  - **链路层**的差错检测由网络适配器中的**硬件实现**，能执行复杂的**CRC运算**

### 6.2.3 循环冗余检测

- **循环冗余检测（CRC）编码**，也称为**多项式编码**，将要发送的比特串看作系数是0或1的多项式，对比特串的操作被解释为多项式算术
- 对于发送d比特的数据D，发送方和接收方协商一个r+1比特模式，称为生成多项式G，G的最高有效位必须是1
- **发送方**：对于一个给定的**数据D**，选择r个**附加比特R**，得到**d+r比特模式**，使得该数用**模2算术**恰好能**被G整除**
- **接收方**：用G除接收到的d+r比特，如果**余数非0**则出现了**差错**
- R的计算为$R=remainder(D\cdot 2^r / G)$
- **国际标准定义了**8、12、16、32比特的**生成多项式G**

## 6.3 多路访问链路和协议

- 链路的两种类型：**点对点链路**、**广播链路**
- 广播链路中，任何一个节点传输一个帧，每个其他节点都将收到一个副本，如何协调多个发送和接收节点对一个共享广播信道的访问，就是**多路访问问题**
- 规范节点在共享的广播信道上的传输行为的协议，称为**多路访问协议**
- **碰撞**：多个节点可能同时传输帧，**所有节点同时接到多个帧**，即传输的帧在所有接收方处碰撞。此时，没有一个接收节点能有效获取任何帧
- **多路访问协议**可以分为三种类型
  - **信道划分协议**
  - **随机接入协议**
  - **轮流协议**

### 6.3.1 信道划分协议

- **时分**多路复用**TDM**，时间分为时间帧，每个时间帧分为N个时隙，对应N个节点
- **频分**多路复用**FDM**，R bps信道划分为不同的频段，每个频段具有R/N带宽
- **码分**多路复用**CDMA**，给每个节点一个不同的编码，节点通过唯一编码对发送的数据进行编码，多个节点之间可以同时传输，而各自相应的接收方仍能正确接收发送方编码的数据比特

### 6.3.2 随机接入协议

- 传输节点总是以信道的**全部速率（R bps）**进行发送，当有**碰撞**时，涉及碰撞的每个节点**等待一个随机时延**，然后**重发**它的帧，重复此过程直到帧无碰撞为止

#### 时隙ALOHA协议

- 假设帧的长度为L比特，时间被划分为长度为L/R的时隙，即一个时隙等于传输一个帧的时间
- 节点只在时隙起点开始传输帧
- 节点是同步的，每个节点知道时隙何时开始
- 如果一个时隙中多个帧传输，则发生了碰撞
- 碰撞时的操作：检测到碰撞后，在后续的**每个时隙**中以**概率$p$进行重传**，直到该帧传输成功，重传时每个节点**独立**地决定

#### ALOHA协议

- 节点是**不同步**的

- **帧到来**时，节点**立刻将其传输**
- 如果遇到碰撞，则以**概率p重传**，以**概率1-p等待一个时隙**，此后的每个时隙都如此决定，直至传输成功

#### 载波侦听多路访问CSMA协议

- **载波侦听**，节点传输前先**侦听信道**，如果来自另一个节点的帧正在信道上发送，则节点等待直到检测到一小段时间内**信道空闲，才发送**
- 节点发现碰撞后（不进行碰撞检测中的停止传输），并**等待一段随机时延**后**重新进入”侦听-当空闲时传输“**

#### 具有碰撞检测的的载波侦听多路访问CSMA/CD协议

- **碰撞检测**，节点在传输时一直侦听信道，如果**检测到**另一个节点正在传输**干扰帧**，则**停止传输**，并**等待一段随机时延**后**重新进入”侦听-当空闲时传输“**

- 为什么进行了**载波侦听**还会**发生碰撞**？

  因为广播信道的端到端**信道传播时延**，即另一个节点已经发送帧，但由于传播时延，节点未在信道侦听到另一个节点传播的帧，仍决定开始发送，由此发生了碰撞

- CSMA/CD协议的完整描述

  - 适配器从网络层获得**数据报**，准备**链路层帧**，将其放入帧适配器**缓存**中
  - 如果适配器侦听到信道**空闲**，则**开始传输**；如果信道**正忙**，则**等待**直到没有信号能量时才开始传输帧
  - 在**传输过程**中，适配器**监视**来自其他使用该广播信道的适配器的**信号能量的存在**
  - 如果适配器传输整个帧而**未检测**到来自其他适配器的信号能量，则适配器**完成了该帧**
  - 如果适配器传输时**检测**到来自**其他适配器的能量**，则**终止传输**
  - **终止传输**后，适配器**等待**一个**随机时间量**，然后返回**步骤2**

- **等待时间**的确定——**二进制指数后退算法**

  - 一个帧经历了一连串的n次碰撞后，将**随机**地在$[0,2^n-1]$之间选择$K$值，并**等待$K\cdot 512$比特时间**（即发送512比特进入以太网所需时间的K倍）
  - 因此该帧**连续碰撞次数越多**，可能等待的**时间就越长**

### 6.3.3 轮流协议

- 多路访问协议的两个理想特性
  - 只有一个节点活跃时，该节点具有R bps的吞吐量
  - 有M个节点活跃时，每个节点具有R/M bps的吞吐量
- **轮询协议**
  - **主节点**
  - 以循环的方式**轮询**每个节点，向节点1发送报文，告诉它能传输的帧的最多数量，节点1完成传输后，向节点2发送报文，以此类推
  - 优点：**消除了碰撞和空时隙**
  - 缺点：引入了**轮询时延**、**主节点故障**将导致整个信道不可用
- **令牌传递协议**
  - 没有主节点
  - 一个称为**令牌**的小的特殊帧在节点之间以某种**固定的次序**进行交换
  - 如果节点有**需要发送**的帧则**持有令牌**，并发送最大数目的帧数，否则**将令牌传递给下一个节点**
  - 优点：**分散**，具有很**高效率**
  - 缺点：**一个节点的故障**可能使整个信道不可用，节点可能忘记释放令牌

### 6.3.4 DOCSIS: 用于电缆因特网接入的链路层协议

- **电缆接入网**将几千个住宅电缆调制解调器与同一个电缆调制解调器短接系统CMTS连接
- **数据经电缆服务接口DOCSIS**定义了**电缆数据网络体系结构及其协议**
- DOCSIS具体内容
  - **FDM**：使用**FDM**将**下行和上行网络段**划分为多个**频率信道**，下行信道仅有单一的CMTS传输，上行信道有多个电缆调制解调器共享
  - **TDM**：每个**上行信道**使用**TDM**划分为多个**时间间隔**，每个时间间隔包含一个**微时隙序列**
  - CMTS在下行信道发送**MAP报文**，**显式地准许**某个电缆调制解调器在特定的微时隙进行传输，因此CMTS能确保在微时隙中**没有碰撞传输**
  - **随机接入协议**：**电缆调制解调器**在一组特殊的**微时隙间隔**内向CMTS发送**微时隙请求帧**告知CMTS自己有数要发送，如果它在下一个下行控制报文中没有收到对请求分配的响应，则推断出发生了碰撞，使用**二进制指数回退法**进行等待并重新发送微时隙请求帧

## 6.4 交换局域网

### 6.4.1 链路层地址和ARP

#### MAC地址

- 每台**适配器**都有一个**固定且唯一**的**链路层地址**，称为MAC地址
- 在**以太网**或**802.11无线局域网**中，MAC地址长度为**6字节**，常用**十六进制表示法**，如`1A-23-F9-CD-06-9B`
- MAC地址具有**扁平结构**，IP地址具有层次结构，MAC地址**不会随适配器的移动而改变**，IP地址则会随主机的移动而改变
- 适配器向某目的适配器发送链路层帧时，需要**将目的适配器的MAC地址**插入到该帧中
- 适配器收到一个帧，会将**目的MAC地址**与**自己的MAC地址**进行比对，若**匹配**则提取数据报并**向上传递**，否则**丢弃**该帧
- **MAC广播地址**，对于以太网或802.11无线局域网，为`FF-FF-FF-FF-FF-FF`

#### 地址解析协议ARP

- 每台主机或路由器的内存中具有一个**ARP表**，包含其所在子网中的**IP地址到MAC地址的映射**关系
- 当发送数据报时，通过ARP表获取目的IP地址对应的**目的MAC地址**，与**数据报**一起放入**链路层帧**进行发送
- ARP表工作原理
  - 当使用目的IP地址查询MAC地址时，ARP表有对应的表项，则直接得到了目的**MAC地址**
  - 没有对应的表项，则向适配器传递一个**ARP查询分组**，目的MAC地址为**MAC广播地址`FF-FF-FF-FF-FF-FF`**，该适配器将帧广播进子网中，该子网中的每个适配器都将该ARP查询分组向上传递到ARP模块，ARP模块检查IP地址是否匹配，若匹配则向查询主机返回一个带有所希望映射的**响应ARP分组**，目的主机收到响应ARP分组后**更新ARP表**，并**发送它的IP数据报**
  - 上述过程中，ARP查询分组是**广播帧**，而ARP响应分组是**标准帧**
  - ARP是即插即用的，即ARP表是**自动建立的**
  - ARP表的每个表项都有**过期时间**
- ARP是**跨越链路层和网络层边界**的协议，用于提供同一子网中的IP地址向MAC地址的转换服务

#### 发送数据报到子网外

- 在**网络层路由选择协议**的作用下，发送数据报到子网外时，一般会先发送到**子网的网关路由器**。因此源主机会将数据报和**该网关路由器的MAC地址**（通过**ARP**获取）放进链路层帧进行发送
- 链路层帧到达网关路由器时，它将提取数据报向上传递，并根据**路由器转发表**转发到恰当的**输出端口**
- 该输出端口已经属于目的主机所在的子网了，因此它将数据报和**目的主机适配器的MAC地址**（通过**ARP**获取）放进链路层帧进行发送，最终**数据报会到达目的主机**

### 6.4.2 以太网

- 以太网时最为流行的有线局域网技术

#### 以太网帧结构

- 发展历史
  - **总线拓扑**，使用**同轴电缆总线**，**广播局域网**
  - **星型拓扑**，使用**集线器**，广播局域网
  - **交换机**，具有存储转发功能，无碰撞问题，**端到端通信链路**

- 以太网**帧结构**
  - **前同步码**，用于锁定适配器的时钟b
  - **目的地址**，目的适配器的MAC地址
  - **源地址**，源设配器的MAC地址
  - **类型**，以太网可以复用多种网络层协议，通过**类型字段**指示将数据**传递给哪个网络层协议**（多路分解），如IP协议、ARP协议（跨越链路层和网络层的协议）
  - **数据**，46-1500字节，承载IP数据报时若超过1500字节需要对其进行分片
  - **CRC**，差错检测

#### 以太网技术

- 略

### 6.4.3 链路层交换机

- 交换机的**任务**：**接收**入链路的**链路层帧**，**转发**到对应的出链路的（先放入出链路的**输出缓存**中，适当时机再发送）

#### 交换机转发和过滤

- **过滤**是决定帧应该被转发还是丢弃
- **转发**是决定帧应该导向哪个接口
- 交换机的过滤和转发借助于**交换机表**，交换机表的表项由**MAC地址**、通向该MAC地址的**交换机接口**、表项放置在表中的**时间**组成
- 交换机转发和过滤的**三种可能**，假设它从交换机接口x收到MAC地址为`AA-AA-AA-AA-AA-AA`的链路层帧
  - 交换机表中**包含**MAC地址为`AA-AA-AA-AA-AA-AA`的表项，且其交换机**接口为x**，则**丢弃**该帧
  - 交换机表中**包含**MAC地址为`AA-AA-AA-AA-AA-AA`的表项，且其交换机接**口为y**，则将该帧**放入接口y的输出缓存**中
  - 交换机表中**不包含**MAC地址为`AA-AA-AA-AA-AA-AA`的表项，则将该帧**放入每个接口的输出缓存**中（**广播**该帧）

#### 自学习

- 交换机表是自动、动态、自治地建立起来的，即**交换机表是自学习的**
- 交换机表**初始为空**
- 对于**每个接口接收到的每个入帧**，在交换机表中**添加一个表项**，存储该帧的源地址字段中的**MAC地址，该帧到达的接口，当前时间**
- 一段时间后，若没接收到该地址作为源地址的帧，则**删除该地址**
- 交换机是**即插即用设备**，无需管理员或用户进行干预即可工作

#### 链路层交换机的性质

- **消除碰撞**，交换机具有输出缓存，不会在网段上同时传输多于一个帧
- **异质的链路**，交换机将链路彼此隔离，
- **管理**，安全性等

#### 交换机和路由器的比较

- 交换机是第二层分组交换机，路由器是第三层分组交换机
- **交换机基于MAC地址**转发，基于目的地转发的**路由器基于IP地址**转发（通用转发的路由器可以基于第二层、第三层、第四层的地址进行转发）
- **交换机**优缺点
  - 优点：**即插即用**、较**高**的分组**过滤和转发速率**
  - 缺点：交换网络的拓扑限制为一棵**生成树**，大型网络生成较大的ARP表，其ARP流量和处理量较大
- **路由器**优缺点
  - 优点：由于IP数据报具有TTL字段，**不存在分组循环问题**，，可以提供**防火墙**保护
  - 缺点：不是即插即用，需要**人为配置**IP地址，**处理时间长**于交换机
- 交换机和路由器是候选的互联设备，它们都可以用于互联不同的局域网
  - 由几百台主机组成的**小网络**通常使用**交换机**
  - 由几千台主机组成的**大网络**则在交换机基础上再**配置路由器**

#### 6.4.4 虚拟局域网VLAN

- 支持**虚拟局域网**的交换机允许经一个**单一的物理局域网基础设施**定义**多个虚拟局域网**
- 交换机的**端口**由网络管理员**划分为组**，**每个组构成一个VLAN**
- **每个VLAN**的端口形成一个**广播域**，即一个端口的**广播流量**只能到达**该组中的其他端口**

- 使用 **VLAN 干线**连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为**干线接口**，以**互连 VLAN 交换机**
- IEEE 定义了一种扩展的**以太网帧格式 802.1Q**，它在标准以太网帧上加进了 **4 字节首部 VLAN 标签**，用于**表示该帧属于哪一个虚拟局域网**

## 6.5 链路虚拟化: 网络作为链路层

- 略

## 6.6 数据中心网络

- 略

## 6.7 回顾: Web页面请求的过程

- 准备：**DCHP、UDP、IP和以太网**
  - 从便携机连接到局域网的交换机开始，首先运行DHCP协议获取主机的IP地址、局域网网关路由器的IP地址、DNS服务器的IP地址等信息
- 仍在准备：**DNS和ARP**
  - 通过ARP协议查询DNS服务器IP地址对应的MAC地址
- 仍在准备：**域内路由选择到DNS服务器**
  - 通过DNS协议查询Web页面服务器对应的IP地址
- Web客户-服务器交互：**TCP和HTTP**
  - 与服务器进行三次握手，发送HTTP请求报文，收到HTTP响应报文并在浏览器中显示

