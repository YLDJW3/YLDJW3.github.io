<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Talk is cheap, show me the code.">
<meta property="og:type" content="website">
<meta property="og:title" content="元朗食品">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="元朗食品">
<meta property="og:description" content="Talk is cheap, show me the code.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Young">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>元朗食品</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">元朗食品</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Young"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Young</p>
  <div class="site-description" itemprop="description">Talk is cheap, show me the code.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


<!-- require APlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">

<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<!-- require MetingJS-->

<script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script> 
<!--playlist外链地址-->   
<meting-js
  server="tencent"
  type="playlist" 
  id="8356942170"
  mini="false"
  fixed="false"
  list-folded="true"
  autoplay="false"
  volume="0.4"
  theme="#FADFA3"
  order="list"
  loop="all"
  preload="auto"
  lrc-type="1"
  mutex="true">
</meting-js>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/14/git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/14/git/" class="post-title-link" itemprop="url">git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-14 21:31:37" itemprop="dateCreated datePublished" datetime="2022-04-14T21:31:37+08:00">2022-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-16 22:04:50" itemprop="dateModified" datetime="2022-04-16T22:04:50+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>git常用命令</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/14/git/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/10/%E6%95%B0%E6%8D%AE%E5%BA%93-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/10/%E6%95%B0%E6%8D%AE%E5%BA%93-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">数据库-数据存储结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-10 12:36:09" itemprop="dateCreated datePublished" datetime="2022-04-10T12:36:09+08:00">2022-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-12 00:18:22" itemprop="dateModified" datetime="2022-04-12T00:18:22+08:00">2022-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Database-System/" itemprop="url" rel="index"><span itemprop="name">Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>数据库是怎么存储数据的？</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/10/%E6%95%B0%E6%8D%AE%E5%BA%93-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/Mac-M1-VScode%E9%85%8D%E7%BD%AEC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/09/Mac-M1-VScode%E9%85%8D%E7%BD%AEC/" class="post-title-link" itemprop="url">Mac M1 VScode配置C++</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-09 22:04:29" itemprop="dateCreated datePublished" datetime="2022-04-09T22:04:29+08:00">2022-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-16 22:05:22" itemprop="dateModified" datetime="2022-04-16T22:05:22+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Mac M1配置VSCode的C++环境</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/09/Mac-M1-VScode%E9%85%8D%E7%BD%AEC/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/B+%E6%A0%91%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/09/B+%E6%A0%91%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">B+树并发控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-04-09 01:16:27 / 修改时间：23:15:04" itemprop="dateCreated datePublished" datetime="2022-04-09T01:16:27+08:00">2022-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Database-System/" itemprop="url" rel="index"><span itemprop="name">Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>索引查找的多线程并发控制原理</strong></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/09/B+%E6%A0%91%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/hexo%E6%97%A0%E6%B3%95%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/08/hexo%E6%97%A0%E6%B3%95%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">hexo无法插入图片的解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-04-08 22:18:16 / 修改时间：22:23:24" itemprop="dateCreated datePublished" datetime="2022-04-08T22:18:16+08:00">2022-04-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="hexo-asset-image">hexo-asset-image</h2>
<ul>
<li>大多数技术博客提到的插入图片方法，都是基于hexo-asset-image@0.0.5实现的，而直接安装hexo-asset-image对应的是1.0.0版本，所以导致插入图片失败</li>
<li>将hexo 根目录下的
<code>/node_modules/hexo-asset-image/index.js</code>文件替换为下列文件即可恢复到hexo-asset-image@0.0.5版本</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">&#x27;cheerio&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">str, m, i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(m, i).join(m).length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> version = <span class="built_in">String</span>(hexo.version).split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">hexo.extend.filter.register(<span class="string">&#x27;after_post_render&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">if</span>(config.post_asset_folder)&#123;</span><br><span class="line">        <span class="keyword">var</span> link = data.permalink;</span><br><span class="line">    <span class="keyword">if</span>(version.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">Number</span>(version[<span class="number">0</span>]) == <span class="number">3</span>)</span><br><span class="line">       <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">&#x27;/&#x27;</span>, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">&#x27;/&#x27;</span>, <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;.../about/index.html&quot;.</span></span><br><span class="line">    <span class="keyword">var</span> endPos = link.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">    link = link.substring(beginPos, endPos);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toprocess = [<span class="string">&#x27;excerpt&#x27;</span>, <span class="string">&#x27;more&#x27;</span>, <span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; toprocess.length; i++)&#123;</span><br><span class="line">      <span class="keyword">var</span> key = toprocess[i];</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">var</span> $ = cheerio.load(data[key], &#123;</span><br><span class="line">        <span class="attr">ignoreWhitespace</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">xmlMode</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">lowerCaseTags</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">decodeEntities</span>: <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      $(<span class="string">&#x27;img&#x27;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>))&#123;</span><br><span class="line">            <span class="comment">// For windows style path, we replace &#x27;\&#x27; to &#x27;/&#x27;.</span></span><br><span class="line">            <span class="keyword">var</span> src = $(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>).replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="regexp">/http[s]*.*|\/\/.*/</span>.test(src) &amp;&amp;</span><br><span class="line">               !<span class="regexp">/^\s*\//</span>.test(src)) &#123;</span><br><span class="line">              <span class="comment">// For &quot;about&quot; page, the first part of &quot;src&quot; can&#x27;t be removed.</span></span><br><span class="line">              <span class="comment">// In addition, to support multi-level local directory.</span></span><br><span class="line">              <span class="keyword">var</span> linkArray = link.split(<span class="string">&#x27;/&#x27;</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> elem != <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="keyword">var</span> srcArray = src.split(<span class="string">&#x27;/&#x27;</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> elem != <span class="string">&#x27;&#x27;</span> &amp;&amp; elem != <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="keyword">if</span>(srcArray.length &gt; <span class="number">1</span>)</span><br><span class="line">                srcArray.shift();</span><br><span class="line">              src = srcArray.join(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">              $(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>, config.root + link + src);</span><br><span class="line">              <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">&quot;update link as:--&gt;&quot;</span>+config.root + link + src);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">&quot;no src attr, skipped...&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info($(<span class="built_in">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      data[key] = $.html();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/B+tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/08/B+tree/" class="post-title-link" itemprop="url">B+tree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-04-08 20:27:12 / 修改时间：22:10:44" itemprop="dateCreated datePublished" datetime="2022-04-08T20:27:12+08:00">2022-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Database-System/" itemprop="url" rel="index"><span itemprop="name">Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>数据库索引数据结构——B+树总结</strong></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/08/B+tree/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/05/C++-%E5%AE%9E%E7%8E%B0Vector/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/05/C++-%E5%AE%9E%E7%8E%B0Vector/" class="post-title-link" itemprop="url">C++ 实现Vector</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-05 23:10:19" itemprop="dateCreated datePublished" datetime="2022-04-05T23:10:19+08:00">2022-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-08 20:08:32" itemprop="dateModified" datetime="2022-04-08T20:08:32+08:00">2022-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="vector">Vector</h1>
<h2 id="数据成员">数据成员</h2>
<ul>
<li>容量：capacity，表示当前数组的大小</li>
<li>大小：sz，表示当前Vector存放的元素个数</li>
<li>存放数据的数组arr</li>
</ul>
<h2 id="接口">接口</h2>
<h3 id="构造函数">构造函数</h3>
<ul>
<li>默认构造函数</li>
<li>接受元素数量参数的构造函数</li>
<li>接受元素数量参数和元素初始值的构造函数</li>
<li>接受初始值列表的构造函数</li>
<li>拷贝构造函数</li>
<li>移动构造函数</li>
</ul>
<h3 id="赋值运算符">赋值运算符</h3>
<ul>
<li>拷贝赋值运算符</li>
<li>移动赋值运算符</li>
</ul>
<h3 id="增加元素">增加元素</h3>
<ul>
<li>insert</li>
<li>push_back</li>
</ul>
<h3 id="删除元素">删除元素</h3>
<ul>
<li>pop_back</li>
<li>erase</li>
</ul>
<h3 id="获取信息">获取信息</h3>
<ul>
<li>size</li>
<li>empty</li>
<li>getCapacity</li>
</ul>
<h3 id="访问元素">访问元素</h3>
<ul>
<li>重载[]运算符</li>
</ul>
<h3 id="扩容">扩容</h3>
<ul>
<li>reserve，用户请求容量</li>
<li>grow，当溢出时将容量扩大为之前的两倍（使得添加元素的均摊复杂度为O(1)）</li>
</ul>
<h2 id="实现">实现</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;initializer_list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vector</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// 默认构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(): <span class="built_in">arr</span>(<span class="literal">nullptr</span>), <span class="built_in">capacity</span>(<span class="number">1</span>), <span class="built_in">sz</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接受元素数量的构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(<span class="keyword">int</span> cnt): <span class="built_in">arr</span>(<span class="keyword">new</span> T[std::<span class="built_in">max</span>(<span class="number">1</span>, cnt * <span class="number">2</span>)]), <span class="built_in">capacity</span>(std::<span class="built_in">max</span>(<span class="number">1</span>, cnt * <span class="number">2</span>)), <span class="built_in">sz</span>(cnt) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接受元素数量和元素值的构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(<span class="keyword">int</span> cnt, T val): <span class="built_in">arr</span>(<span class="keyword">new</span> T[std::<span class="built_in">max</span>(<span class="number">1</span>, cnt * <span class="number">2</span>)]), <span class="built_in">capacity</span>(std::<span class="built_in">max</span>(<span class="number">1</span>, cnt * <span class="number">2</span>)), <span class="built_in">sz</span>(cnt) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i) &#123;</span><br><span class="line">			arr[i] = val;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接受初始值列表的构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(std::initializer_list&lt;T&gt; li): <span class="built_in">arr</span>(<span class="keyword">new</span> T[std::<span class="built_in">max</span>(<span class="number">1</span>, (<span class="keyword">int</span>)li.<span class="built_in">size</span>() * <span class="number">2</span>)]), <span class="built_in">capacity</span>(std::<span class="built_in">max</span>(<span class="number">1</span>, (<span class="keyword">int</span>)li.<span class="built_in">size</span>() * <span class="number">2</span>)), <span class="built_in">sz</span>(li.<span class="built_in">size</span>()) &#123;</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v: li) &#123;</span><br><span class="line">			arr[i] = v;</span><br><span class="line">			++i;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(<span class="keyword">const</span> Vector&amp; other) &#123;</span><br><span class="line">		arr = <span class="keyword">new</span> T[other.capacity];</span><br><span class="line">		capacity = other.capacity;</span><br><span class="line">		sz = other.sz;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i)</span><br><span class="line">			arr[i] = other.arr[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动构造函数</span></span><br><span class="line">	<span class="built_in">Vector</span>(Vector&amp;&amp; other) &#123;</span><br><span class="line">		arr = other.arr;</span><br><span class="line">		capacity = other.capacity;</span><br><span class="line">		sz = other.sz;</span><br><span class="line">		other.arr = <span class="literal">nullptr</span>;</span><br><span class="line">		other.capacity = <span class="number">0</span>;</span><br><span class="line">		other.sz = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝赋值运算符</span></span><br><span class="line">	Vector&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Vector&amp; other) &#123;</span><br><span class="line">		arr = <span class="keyword">new</span> T[other.capacity];</span><br><span class="line">		capacity = other.capacity;</span><br><span class="line">		sz = other.sz;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i)</span><br><span class="line">			arr[i] = other.arr[i];</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动赋值运算符</span></span><br><span class="line">	Vector&amp; <span class="keyword">operator</span>=(Vector&amp;&amp; other) &#123;</span><br><span class="line">		arr = other.arr;</span><br><span class="line">		capacity = other.capacity;</span><br><span class="line">		sz = other.sz;</span><br><span class="line">		other.arr = <span class="literal">nullptr</span>;</span><br><span class="line">		other.capacity = <span class="number">0</span>;</span><br><span class="line">		other.sz = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 析构函数</span></span><br><span class="line">	~<span class="built_in">Vector</span>() &#123;</span><br><span class="line">		<span class="keyword">delete</span>[] arr;</span><br><span class="line">		arr = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 插入</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> pos, T val)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (sz == capacity)</span><br><span class="line">			<span class="built_in">grow</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = sz; i &gt; pos; --i)</span><br><span class="line">			arr[i] = arr[i - <span class="number">1</span>];</span><br><span class="line">		arr[pos] = val;</span><br><span class="line">		++sz;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除第一个等于val的元素</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(T val)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> (arr[i] == val) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; sz - <span class="number">1</span>; ++j) &#123;</span><br><span class="line">					arr[j] = arr[j + <span class="number">1</span>];</span><br><span class="line">				&#125;</span><br><span class="line">				--sz;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 末尾添加/删除</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(T val)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (sz == capacity)</span><br><span class="line">			<span class="built_in">grow</span>();</span><br><span class="line">		arr[sz] = val;</span><br><span class="line">		++sz;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pop_back</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">empty</span>()) &#123;</span><br><span class="line">			--sz;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回元素数量</span></span><br><span class="line">	<span class="function"><span class="keyword">size_t</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sz;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回是否空的vector</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sz == <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 随机访问</span></span><br><span class="line">	T&amp; <span class="keyword">operator</span>[](<span class="keyword">int</span> index) &#123;</span><br><span class="line">		<span class="keyword">if</span> (index &gt;= sz || index &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">throw</span> <span class="string">&quot;Out of range&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> arr[index];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 扩容reserve</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reserve</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (cap &lt;= capacity)</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		T* newArrary = <span class="keyword">new</span> T[cap];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i)</span><br><span class="line">			newArrary[i] = arr[i];</span><br><span class="line">		<span class="keyword">delete</span> arr;</span><br><span class="line">		arr = newArrary;</span><br><span class="line">		capacity = cap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 测试接口, 获取当前容量</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> capacity;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 测试接口, 获取当前数组</span></span><br><span class="line">	<span class="function">T* <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> arr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	T* arr;</span><br><span class="line">	<span class="keyword">int</span> capacity;</span><br><span class="line">	<span class="keyword">int</span> sz;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 溢出, 分配当前两倍的空间</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">grow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		T* newArrary = <span class="keyword">new</span> T[capacity * <span class="number">2</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; ++i)</span><br><span class="line">			newArrary[i] = arr[i];</span><br><span class="line">		<span class="keyword">delete</span> arr;</span><br><span class="line">		arr = newArrary;</span><br><span class="line">		capacity *= <span class="number">2</span>;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BasicTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="function">Vector&lt;<span class="keyword">int</span>&gt; <span class="title">vec</span><span class="params">(<span class="number">10</span>, <span class="number">3</span>)</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)vec.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		std::cout &lt;&lt; vec[i] &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		<span class="built_in">assert</span>(vec[i] == <span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	vec.<span class="built_in">push_back</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">size</span>() == <span class="number">11</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec[<span class="number">10</span>] == <span class="number">4</span>);</span><br><span class="line">	vec.<span class="built_in">pop_back</span>();</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">size</span>() == <span class="number">10</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;BasicTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopyTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="function">Vector&lt;<span class="keyword">int</span>&gt; <span class="title">v1</span><span class="params">(<span class="number">10</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">	Vector&lt;<span class="keyword">int</span>&gt; v2 = v1;</span><br><span class="line">	<span class="function">Vector&lt;<span class="keyword">int</span>&gt; <span class="title">v3</span><span class="params">(v2)</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)v2.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		<span class="built_in">assert</span>(v2[i] == <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)v3.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		<span class="built_in">assert</span>(v3[i] == <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;CopyTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InsertTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="function">Vector&lt;<span class="keyword">int</span>&gt; <span class="title">vec</span><span class="params">(<span class="number">10</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">	vec.<span class="built_in">insert</span>(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">size</span>() == <span class="number">11</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)vec.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		<span class="built_in">assert</span>(vec[i] == (i == <span class="number">0</span>? <span class="number">3</span>: <span class="number">1</span>));</span><br><span class="line">		std::cout &lt;&lt; vec[i] &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;InsertTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EraseTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Vector&lt;<span class="keyword">int</span>&gt; vec&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">	vec.<span class="built_in">erase</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">size</span>() == <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)vec.<span class="built_in">size</span>(); ++i)</span><br><span class="line">		std::cout &lt;&lt; vec[i] &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;EraseTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReserveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Vector&lt;<span class="keyword">int</span>&gt; vec&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">getCapacity</span>() == <span class="number">10</span>);</span><br><span class="line">	vec.<span class="built_in">reserve</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">getCapacity</span>() == <span class="number">10</span>);</span><br><span class="line">	vec.<span class="built_in">reserve</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="built_in">assert</span>(vec.<span class="built_in">getCapacity</span>() == <span class="number">11</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)vec.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		<span class="built_in">assert</span>(vec[i] == i);</span><br><span class="line">		std::cout &lt;&lt; vec[i] &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;ReserveTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GrowTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Vector&lt;<span class="keyword">int</span>&gt; v&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	v.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">assert</span>(v.<span class="built_in">getCapacity</span>() == <span class="number">2</span>);</span><br><span class="line">	v.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">assert</span>(v.<span class="built_in">getCapacity</span>() == <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">assert</span>(v.<span class="built_in">size</span>() == <span class="number">3</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;GrowTest passed\n&quot;</span>;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Vector&lt;<span class="keyword">int</span>&gt; v1&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">	<span class="function">Vector&lt;<span class="keyword">int</span>&gt; <span class="title">v2</span><span class="params">(std::move(v1))</span></span>;</span><br><span class="line">	<span class="built_in">assert</span>(v1.<span class="built_in">size</span>() == <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">assert</span>(v1.<span class="built_in">getData</span>() == <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">assert</span>(v2.<span class="built_in">size</span>() == <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)v2.<span class="built_in">size</span>(); ++i)</span><br><span class="line">		<span class="built_in">assert</span>(v2[i] == i);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;MoveTest passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">BasicTest</span>();</span><br><span class="line">	<span class="built_in">CopyTest</span>();</span><br><span class="line">	<span class="built_in">InsertTest</span>();</span><br><span class="line">	<span class="built_in">EraseTest</span>();</span><br><span class="line">	<span class="built_in">ReserveTest</span>();</span><br><span class="line">	<span class="built_in">GrowTest</span>();</span><br><span class="line">	<span class="built_in">MoveTest</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/05/C++-%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/05/C++-%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" class="post-title-link" itemprop="url">C++-实现智能指针</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-05 20:49:44" itemprop="dateCreated datePublished" datetime="2022-04-05T20:49:44+08:00">2022-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-08 20:08:32" itemprop="dateModified" datetime="2022-04-08T20:08:32+08:00">2022-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="智能指针原理">智能指针原理</h1>
<h2 id="shared_ptr">shared_ptr</h2>
<h3 id="引用计数">引用计数</h3>
<ul>
<li>shared_ptr包含两个指针，一个指向所共享的对象，另一个指向引用计数器，此外还保存着指向删除器的指针</li>
<li>当对shared_ptr进行拷贝时，引用计数加1，当shared_ptr被销毁时，引用计数减1。特别地，如果某个shared_ptr在销毁时引用计数为0，则需要对所共享的对象进行销毁并释放相应的内存</li>
</ul>
<h3 id="线程安全性">线程安全性</h3>
<ul>
<li>基于上述原理，对shared_ptr的操作包含对其指向对象的指针，以及指向引用计数的指针的修改，操作不具有原子性，因此多线程修改shared_ptr时可能出现race
condition，不具有线程安全性</li>
</ul>
<h2 id="unique_ptr">unique_ptr</h2>
<ul>
<li>包含指向所拥有对象的指针，不支持拷贝操作，支持移动操作</li>
<li>包含销毁所指对象的删除器</li>
<li>若自定义删除器，则删除器类型也是unique_ptr的模板类型</li>
</ul>
<h1 id="shared_ptr的实现">shared_ptr的实现</h1>
<h2 id="成员变量">成员变量</h2>
<ul>
<li>T* pointer，指向所共享的对象</li>
<li>D* deleter，指向删除器，即销毁所指对象时调用的函数</li>
<li>Counter* ctr，指向引用计数器</li>
</ul>
<h2 id="接口实现">接口实现</h2>
<ul>
<li>构造函数：接受指针的构造函数、拷贝构造函数、移动构造函数</li>
<li>赋值运算符：拷贝赋值运算符、移动赋值运算符</li>
<li>析构函数：引用计数减1，若为0则调用删除器销毁所指对象</li>
<li>重载bool运算符</li>
<li>重载解引用运算符</li>
<li>重载箭头运算符</li>
<li>get()获取裸指针</li>
<li>reset()，reset(ptr)，reset(ptr, del)，放弃对对象的引用</li>
<li>unique()，返回是否唯一引用对象的智能指针</li>
<li>use_count()，返回引用该对象的智能指针数目</li>
<li>swap(shared_ptr&amp; rhs)，与另一个智能指针交换所指对象</li>
</ul>
<h1 id="unique_ptr的实现">unique_ptr的实现</h1>
<h2 id="成员变量-1">成员变量</h2>
<ul>
<li>T* pointer，指向所共享的对象</li>
<li>D
deleter，删除器，即销毁所指对象时调用的函数，默认采用delete删除</li>
</ul>
<h2 id="接口实现-1">接口实现</h2>
<ul>
<li>构造函数：接受指针的构造函数、移动构造函数</li>
<li>赋值运算符：移动赋值运算符</li>
<li>析构函数：采用删除器销毁对象</li>
<li>拷贝构造函数合拷贝赋值运算符定义为delete，表示不支持拷贝操作</li>
<li>重载bool运算符</li>
<li>重载解引用运算符</li>
<li>重载箭头运算符</li>
<li>get()获取裸指针</li>
<li>reset()，reset(ptr)</li>
<li>release()放弃对指针的控制权，返回指针并置空</li>
</ul>
<h1 id="总结">总结</h1>
<ul>
<li><strong>构造函数、赋值运算符</strong>的使用</li>
<li><strong>重载bool、解引用和箭头运算符</strong>的使用</li>
<li><strong>模板类</strong>的使用</li>
<li>shared_ptr和unique_ptr的不同实现原理</li>
<li>shared_ptr和unique_ptr对<strong>删除器的管理方式</strong>：shared_ptr内部包含指向删除器的指针，删除器可以改变，不影响shared_ptr的类型；unique_ptr内部存放了删除器本身，删除器类型不可改变，删除器类型也作为unique_ptr类型的一部分</li>
</ul>
<h1 id="代码">代码</h1>
<h2 id="shared_ptr-1">shared_ptr</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SharedPointer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(SharedPointer&lt;T&gt;&amp; lhs, SharedPointer&lt;T&gt;&amp; rhs)</span> </span>&#123;</span><br><span class="line">	std::<span class="built_in">swap</span>(lhs.pointer, rhs.pointer);</span><br><span class="line">	std::<span class="built_in">swap</span>(lhs.ctr, rhs.ctr);</span><br><span class="line">	std::<span class="built_in">swap</span>(lhs.deleter, rhs.deleter);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">delete</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Counter</span>(<span class="keyword">int</span> cnt = <span class="number">1</span>): <span class="built_in">counter</span>(cnt) &#123;&#125;</span><br><span class="line">	<span class="keyword">int</span> counter;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SharedPointer</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// 默认构造函数</span></span><br><span class="line">	<span class="built_in">SharedPointer</span>(T* ptr = <span class="literal">nullptr</span>, std::function&lt;<span class="built_in"><span class="keyword">void</span></span>(T*)&gt; del = A::Delete&lt;T&gt;): <span class="built_in">pointer</span>(ptr), <span class="built_in">ctr</span>(<span class="keyword">new</span> <span class="built_in">Counter</span>(<span class="number">1</span>)), <span class="built_in">deleter</span>(del) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝构造函数</span></span><br><span class="line">	<span class="built_in">SharedPointer</span>(<span class="keyword">const</span> SharedPointer&amp; other): <span class="built_in">pointer</span>(other.pointer), <span class="built_in">ctr</span>(other.ctr), <span class="built_in">deleter</span>(other.deleter) &#123;</span><br><span class="line">		++ctr-&gt;counter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动构造函数</span></span><br><span class="line">	<span class="built_in">SharedPointer</span>(SharedPointer&amp;&amp; other): <span class="built_in">pointer</span>(other.pointer), <span class="built_in">ctr</span>(other.ctr), <span class="built_in">deleter</span>(other.deleter) &#123;</span><br><span class="line">		other.pointer = <span class="literal">nullptr</span>;</span><br><span class="line">		other.ctr = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝赋值运算符</span></span><br><span class="line">	SharedPointer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> SharedPointer&amp; other) &#123;</span><br><span class="line">		<span class="built_in">decrementAndDestory</span>();</span><br><span class="line">		pointer = other.pointer;</span><br><span class="line">		ctr = other.ctr;</span><br><span class="line">		deleter = other.deleter;</span><br><span class="line">		++ctr-&gt;counter;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动赋值运算符</span></span><br><span class="line">	SharedPointer&amp; <span class="keyword">operator</span>=(SharedPointer&amp;&amp; other) &#123;</span><br><span class="line">		<span class="built_in">decrementAndDestory</span>();</span><br><span class="line">		<span class="built_in">swap</span>(other);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">SharedPointer</span>() &#123;</span><br><span class="line">		<span class="built_in">decrementAndDestory</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将SharedPtr对象作为bool值</span></span><br><span class="line">	<span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pointer? <span class="literal">true</span>: <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重载解引用运算符</span></span><br><span class="line">	T&amp; <span class="keyword">operator</span>*() &#123;</span><br><span class="line">		<span class="keyword">if</span> (!pointer)</span><br><span class="line">			<span class="keyword">throw</span> <span class="string">&quot;Bad operator*&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> *pointer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重载箭头运算符</span></span><br><span class="line">	T* <span class="keyword">operator</span>-&gt;() &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;<span class="keyword">this</span>-&gt;<span class="keyword">operator</span>*();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function">T* <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pointer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">decrementAndDestory</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">decrementAndDestory</span>();</span><br><span class="line">		pointer = ptr;</span><br><span class="line">		ctr = <span class="keyword">new</span> <span class="built_in">Counter</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(T* ptr, <span class="keyword">const</span> std::function&lt;<span class="keyword">void</span>(T*)&gt; del)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">reset</span>(ptr);</span><br><span class="line">		deleter = del;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">unique</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ctr-&gt;counter == <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">use_count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ctr-&gt;counter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(SharedPointer&amp; rhs)</span> </span>&#123;</span><br><span class="line">		A::<span class="built_in">swap</span>(*<span class="keyword">this</span>, rhs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	T* pointer;</span><br><span class="line">	Counter* ctr;</span><br><span class="line">	std::function&lt;<span class="built_in"><span class="keyword">void</span></span>(T*)&gt; deleter;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 递减计数器, 若计数器为0则销毁所指对象, 重置指针值为nullptr</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">decrementAndDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (pointer) &#123;</span><br><span class="line">			--ctr-&gt;counter;</span><br><span class="line">			<span class="keyword">if</span> (ctr-&gt;counter == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">deleter</span>(pointer);</span><br><span class="line">				<span class="keyword">delete</span> ctr;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">delete</span> ctr;</span><br><span class="line">		&#125;</span><br><span class="line">		pointer = <span class="literal">nullptr</span>;</span><br><span class="line">		ctr = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copySharedPointerTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> A;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">2022</span>;</span><br><span class="line">	<span class="function">SharedPointer&lt;<span class="keyword">int</span>&gt; <span class="title">sp1</span><span class="params">(&amp;i)</span></span>;</span><br><span class="line">	<span class="function">SharedPointer&lt;<span class="keyword">int</span>&gt; <span class="title">sp2</span><span class="params">(sp1)</span></span>;</span><br><span class="line">	<span class="built_in">assert</span>(*sp1 == <span class="number">2022</span>);</span><br><span class="line">	<span class="built_in">assert</span>(*sp2 == <span class="number">2022</span>);</span><br><span class="line">	<span class="built_in">assert</span>(sp1.<span class="built_in">use_count</span>() == <span class="number">2</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;copyTest passed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveSharedPointerTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> A;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">2022</span>;</span><br><span class="line">	<span class="function">SharedPointer&lt;<span class="keyword">int</span>&gt; <span class="title">sp1</span><span class="params">(&amp;i)</span></span>;</span><br><span class="line">	<span class="function">SharedPointer&lt;<span class="keyword">int</span>&gt; <span class="title">sp2</span><span class="params">(std::move(sp1))</span></span>;</span><br><span class="line">	<span class="built_in">assert</span>(sp1.<span class="built_in">get</span>() == <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">assert</span>(*sp2 == <span class="number">2022</span>);</span><br><span class="line">	<span class="built_in">assert</span>(sp2.<span class="built_in">use_count</span>() == <span class="number">1</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;moveTest passed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">copySharedPointerTest</span>();</span><br><span class="line">	<span class="built_in">moveSharedPointerTest</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="unique_ptr-1">unique_ptr</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delete</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">delete</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> D = std::function&lt;<span class="built_in"><span class="keyword">void</span></span>(T*)&gt;&gt;</span><br><span class="line">class UniquePointer &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// 默认构造函数</span></span><br><span class="line">	<span class="built_in">UniquePointer</span>(T* ptr = <span class="literal">nullptr</span>, D del = A::Delete&lt;T&gt;): <span class="built_in">pointer</span>(ptr), <span class="built_in">deleter</span>(del) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动构造函数</span></span><br><span class="line">	<span class="built_in">UniquePointer</span>(UniquePointer&amp;&amp; rhs) &#123;</span><br><span class="line">		pointer = rhs.pointer;</span><br><span class="line">		deleter = std::forward&lt;D&gt;(rhs.deleter);</span><br><span class="line">		rhs.pointer = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 移动赋值运算符</span></span><br><span class="line">	UniquePointer&amp; <span class="keyword">operator</span>=(UniquePointer&amp;&amp; rhs) &#123;</span><br><span class="line">		pointer = rhs.pointer;</span><br><span class="line">		deleter = std::forward&lt;D&gt;(rhs.deleter);</span><br><span class="line">		rhs.pointer = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 析构函数</span></span><br><span class="line">	~<span class="built_in">UniquePointer</span>() &#123;</span><br><span class="line">		<span class="built_in">destroy</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝构造函数</span></span><br><span class="line">	<span class="built_in">UniquePointer</span>(<span class="keyword">const</span> UniquePointer&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝赋值运算符</span></span><br><span class="line">	UniquePointer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> UniquePointer&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 裸指针赋值</span></span><br><span class="line">	UniquePointer&amp; <span class="keyword">operator</span>=(T* ptr) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重载bool</span></span><br><span class="line">	<span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pointer? <span class="literal">true</span>: <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重载解引用运算符</span></span><br><span class="line">	T&amp; <span class="keyword">operator</span>*() &#123;</span><br><span class="line">		<span class="keyword">return</span> *pointer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重载箭头运算符</span></span><br><span class="line">	T* <span class="keyword">operator</span>-&gt;() &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;<span class="keyword">this</span>-&gt;<span class="keyword">operator</span>*();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取裸指针</span></span><br><span class="line">	<span class="function">T* <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pointer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 放弃对指针的控制权, 返回指针并置空</span></span><br><span class="line">	<span class="function">T* <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		T* temp = pointer;</span><br><span class="line">		pointer = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">return</span> temp;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 释放所指对象</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="built_in">destroy</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放所指对象, 并指向另一个对象</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">reset</span>();</span><br><span class="line">		pointer = ptr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	T* pointer;</span><br><span class="line">	D deleter;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (pointer) &#123;</span><br><span class="line">			<span class="built_in">deleter</span>(pointer);</span><br><span class="line">			pointer = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> A;</span><br><span class="line">	<span class="function">UniquePointer&lt;<span class="keyword">int</span>&gt; <span class="title">up1</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">	<span class="built_in">assert</span>(*up1 == <span class="number">10</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Basic test passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> A;</span><br><span class="line">	<span class="function">UniquePointer&lt;<span class="keyword">int</span>&gt; <span class="title">up1</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">	<span class="function">UniquePointer&lt;<span class="keyword">int</span>&gt; <span class="title">up2</span><span class="params">(std::move(up1))</span></span>;</span><br><span class="line">	<span class="built_in">assert</span>(*up2 == <span class="number">10</span>);</span><br><span class="line">	<span class="built_in">assert</span>(up1.<span class="built_in">get</span>() == <span class="literal">nullptr</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Move test passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resetTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> A;</span><br><span class="line">	<span class="function">UniquePointer&lt;<span class="keyword">int</span>&gt; <span class="title">up</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">	up.<span class="built_in">reset</span>();</span><br><span class="line">	<span class="built_in">assert</span>(up1.<span class="built_in">get</span>() == <span class="literal">nullptr</span>);</span><br><span class="line">	up.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">2022</span>));</span><br><span class="line">	<span class="built_in">assert</span>(*up1 == <span class="number">2022</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Reset test passed\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">basicTest</span>();</span><br><span class="line">	<span class="built_in">moveTest</span>();</span><br><span class="line">	<span class="built_in">resetTest</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/29/%E5%9B%BE%E8%A7%A3%E7%B3%BB%E7%BB%9F%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/29/%E5%9B%BE%E8%A7%A3%E7%B3%BB%E7%BB%9F%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">图解系统笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-29 11:55:08" itemprop="dateCreated datePublished" datetime="2022-03-29T11:55:08+08:00">2022-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-08 20:08:32" itemprop="dateModified" datetime="2022-04-08T20:08:32+08:00">2022-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Network/" itemprop="url" rel="index"><span itemprop="name">Computer Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="硬件结构">硬件结构</h1>
<h2 id="冯诺依曼模型">冯诺依曼模型</h2>
<ul>
<li><strong>计算机结构</strong>：中央处理器、内存、输入设备、输出设备、总线</li>
</ul>
<h2 id="程序执行的基本过程">程序执行的基本过程</h2>
<ul>
<li><strong>取指</strong>：CPU读取PC得到指令的内存地址，访问该内存得到指令并存入指令寄存器</li>
<li><strong>执行</strong>：分析指令寄存器中的指令，若为计算类型的指令则交给逻辑运算单元运算，若为存储类型的指令则交给控制单元执行</li>
<li><strong>PC自增</strong>：指令执行完后，PC自增指向下一条指令</li>
</ul>
<h2 id="指令周期">指令周期</h2>
<ul>
<li><strong>Fetch</strong>：取得指令</li>
<li><strong>Decode</strong>：指令译码</li>
<li><strong>Execution</strong>：执行指令</li>
<li><strong>Store</strong>：数据回写</li>
</ul>
<h2 id="存储器金字塔">存储器金字塔</h2>
<ul>
<li><strong>寄存器</strong>：读写速度最快</li>
<li><strong>CPU
cache</strong>：读写速度快，存储容量小，静态随机存储器SRAM，分为三级L1、L2、L3
Cache</li>
<li><strong>内存</strong>：动态随机存储器DRAM</li>
<li><strong>SSD/HDD硬盘</strong>：存储容量大，读写速度慢，断电后数据仍存在</li>
</ul>
<h2 id="cpu缓存一致性">CPU缓存一致性</h2>
<ul>
<li>多核CPU中，每个核心都有<strong>各自的L1/L2
Cache</strong>，而<strong>L3
Cache</strong>则是所有核心<strong>共享</strong>使用的</li>
</ul>
<h3 id="写直达">写直达</h3>
<ul>
<li><strong>写直达</strong>：把数据同时写入内存和Cache中</li>
<li><strong>如果数据没有在Cache里面</strong>：直接把数据更新到内存中</li>
<li><strong>缺点</strong>：每次写操作都写回到内存，写操作花费大量时间</li>
</ul>
<h3 id="写回">写回</h3>
<ul>
<li><p><strong>写回</strong>：发生写操作时，新的数据仅仅写入Cache
block，只有当修改过的Cache block被替换时，才需要写到内存中</p></li>
<li><p><strong>写操作时数据已经在CPU Cache中</strong>：数据更新到CPU
Cache里，标记CPU
Cache里的block为dirty，代表该block的数据和内存是不一致的</p></li>
<li><p><strong>写操作时数据不在Cache中</strong>：进行替换，检查被替换的Cache
block是否为dirty，若为dirty则要把Cache
Block里的数据写回到内存，在把当前要写入的数据写入到Cache
block并标记为dirty</p></li>
<li><p><strong>优点</strong>：减少了写内存的次数，性能提高</p></li>
</ul>
<h1 id="操作系统结构">操作系统结构</h1>
<ul>
<li><strong>操作系统的作用</strong>：进程管理、内存管理、设备管理、提供系统调用</li>
</ul>
<h2 id="内核态与用户态">内核态与用户态</h2>
<ul>
<li><p><strong>内核态与用户态</strong>：内核程序执行在内核态，用户程序执行在用户态</p></li>
<li><p>内核态与用户态的切换方式</p>
<p><strong>系统调用</strong>：用户态进程通过系统调用申请使用操作系统提供的服务程序完成工作</p>
<p><strong>异常</strong>：CPU在执行运行在用户态下的程序时，发生了某些事先不可知的异常，这时会触发由当前运行进程切换到处理此异常的内核相关程序中</p>
<p><strong>设备中断</strong>：外围设备完成用户请求的操作后，向CPU发出中断信号</p></li>
<li><p><strong>系统调用</strong>：应用程序使用系统调用时会产生一个<strong>中断</strong>。发生中断后，CPU会中断当前在执行的用户程序，转而跳转到<strong>中断处理程序</strong>，即开始执行内核程序。内核处理完成后，主动触发<strong>中断</strong>，把CPU执行权限交回给<strong>用户程序</strong>，回到用户态继续工作</p></li>
</ul>
<h2 id="宏内核与微内核">宏内核与微内核</h2>
<ul>
<li><strong>宏内核</strong>：系统内核的所有模块都运行在内核态</li>
<li><strong>微内核</strong>：内核只保留最基本的能力，如进程调度、虚拟机内存、中断等</li>
<li><strong>混合类型内核</strong>：内核里有一个最小版本的内核，其他模块在其基础上搭建，但整个内核是仍然作为一个完整程序，大部分服务都在内核中</li>
</ul>
<h1 id="内存管理">内存管理</h1>
<h2 id="虚拟内存的概念">虚拟内存的概念</h2>
<ul>
<li><p><strong>虚拟内存</strong>：操作系统让每个进程都拥有独立的连续地址空间，称为虚拟内存</p></li>
<li><p><strong>虚拟内存地址与物理内存地址</strong>：进程使用虚拟内存地址访问内存，而存在硬件中的实际地址是物理内存地址，虚拟内存地址到物理地址的转换是由硬件<strong>内存管理单元MMU</strong>完成的</p></li>
<li><p><strong>分段/分页</strong>：内存空间常通过分段或分页的方式进行组织</p></li>
</ul>
<h2 id="内存分段">内存分段</h2>
<ul>
<li><p><strong>分段</strong>：程序由若干个逻辑分段组成，如代码分段、数据分段、栈段、堆段，不同的段有不同的属性</p></li>
<li><p><strong>虚拟地址</strong>：由段号和段内偏移量组成</p></li>
<li><p><strong>段表</strong>：虚拟地址通过段表与物理地址进行映射，段表中包含段基地址、段界限</p></li>
<li><p>虚拟地址向物理地址转换的过程</p>
<p><strong>根据段号索引段表</strong>：根据虚拟地址的段号找到段表</p>
<p><strong>检查越界</strong>：对比段内偏移量和段表中的段界限，判断虚拟地址是否合法</p>
<p><strong>得到物理地址</strong>：段基地址加上段内偏移量即得到虚拟地址对应的物理地址</p></li>
<li><p>缺点</p>
<p><strong>内存碎片</strong>：产生多个不连续的小物理内存，导致新的程序无法被装载</p>
<p><strong>内存交换效率低</strong>：为了解决内存碎片问题，采用内存交换方法，先将程序写到硬盘上，再从硬盘读回内存，并紧跟着上一个程序，从而消除了该内存碎片。如果将较大的程序写回硬盘再读入内存，则速度较慢</p></li>
</ul>
<h2 id="内存分页">内存分页</h2>
<ul>
<li><strong>分页</strong>：把整个虚拟和物理内存空间切成一段段固定尺寸的大小，这个连续且尺寸固定的内存空间称为<strong>页</strong></li>
<li><strong>页表</strong>：虚拟地址与物理地址之间通过页表进行映射，内存管理单元MMU负责将虚拟地址映射为物理地址</li>
<li><strong>缺页异常</strong>：当进程访问的虚拟地址在页表中查不到时，产生一个缺页异常，进入内核态由操作系统分配物理内存、更新进程页表，最后返回用户空间继续执行</li>
</ul>
<h3 id="分页怎么解决内存碎片内存交换效率低等问题">分页怎么解决内存碎片、内存交换效率低等问题</h3>
<ul>
<li><p><strong>内存碎片问题</strong>：采用分页，内存的释放是以页为单位进行的，不会产生无法给进程使用的小内存</p></li>
<li><p><strong>内存交换效率问题</strong>：<strong>LRU策略</strong>，当内存空间不足时，若需要换入新页面，则操作系统将最久未被使用的内存页面释放掉</p></li>
<li><p><strong>Demand
paging</strong>：加载程序时，无需把整个程序加载到物理内存中，而是在进程使用该页时，发生缺页异常时由操作系统将该页换入内存中</p></li>
</ul>
<h3 id="虚拟地址和物理地址的映射">虚拟地址和物理地址的映射</h3>
<ul>
<li><p><strong>虚拟地址</strong>：分为页号和页内偏移量</p></li>
<li><p><strong>页表</strong>：包含物理页所在的物理内存基地址，由该基地址和页内偏移量组合得到虚拟地址对应的物理地址</p></li>
<li><p><strong>地址转换</strong>的步骤</p>
<p>虚拟地址划分为<strong>页号</strong>和<strong>偏移量</strong></p>
<p>根据页号从页表里查询得到物理页所在内存的<strong>物理内存基地址</strong></p>
<p>将物理页基地址加上<strong>页内偏移量</strong>得到<strong>物理内存地址</strong></p></li>
<li><p><strong>分页的缺点</strong></p>
<p><strong>页表占用较大存储空间</strong>：若页的大小为4KB，而虚拟地址空间为4GB，则共有<span class="math inline">\(2^{20}\)</span>个页，每个页表项为4字节，则共需要4MB空间存放页表</p></li>
</ul>
<h3 id="多级页表">多级页表</h3>
<ul>
<li><strong>目的</strong>：解决页表占用过多存储空间的问题</li>
<li><strong>原理</strong>：将上述<span class="math inline">\(2^{20}\)</span>个页建立两级页表，一级页表包含1024个页表项，对应1024个二级页表；二级页表也包含1024个页表项，对应<span class="math inline">\(2^{20}\)</span>个物理页</li>
<li><strong>优点</strong>：进程并非需要页表中的每一项，因此部分页表项是空的，即一级页表中的部分表项不需要建立对应的二级页表。具体地，考虑一个进程只使用了4MB的连续空间，则只需要一个一级页表和一个二级页表即可，总共<span class="math inline">\(2*2^{10}\)</span>个页表项。若不采用多级页表，则他仍然需要为每个页建立一个页表项，共<span class="math inline">\(2^{20}\)</span>个页表项</li>
<li><strong>速记</strong>：一级页表必须覆盖所有内存空间，二级页表按需建立，因此可以减小存储空间</li>
</ul>
<h3 id="局部性原理">局部性原理</h3>
<ul>
<li><strong>时间局部性</strong>：程序中的某条指令一旦执行，则不久后该指令很可能会再次执行（循环）</li>
<li><strong>空间局部性</strong>：程序访问了某个存储单元，则不久后其附近的存储单元也很可能被访问（指令顺序执行、数组）</li>
</ul>
<h3 id="tlb">TLB</h3>
<ul>
<li><strong>多级页表缺点</strong>：虽然解决了存储空间上的问题，但从虚拟地址到物理地址的转换步骤更加复杂，增加了时间上的开销</li>
<li><strong>TLB</strong>：CPU中加入一个专门存放程序最常访问页表项的Cache（TLB），也称为快表、页表缓存等</li>
</ul>
<h2 id="段页式内存管理">段页式内存管理</h2>
<ul>
<li><p>实现</p>
<p><strong>分段</strong>：程序划分为多个有逻辑意义的段</p>
<p><strong>分页</strong>：对分段划分出来的连续空间，再划分固定大小的页</p></li>
<li><p><strong>虚拟地址</strong>：段号、段内页号、页内偏移量</p></li>
<li><p><strong>地址转换过程</strong></p>
<p>第一次访问段表，得到<strong>页表起始地址</strong></p>
<p>第二次访问页表，得到<strong>物理页号</strong></p>
<p>第三次将物理页号和页内偏移量结合，得到<strong>物理地址</strong></p></li>
</ul>
<h2 id="xv6的内存管理">xv6的内存管理</h2>
<h1 id="进程与线程">进程与线程</h1>
<h2 id="进程">进程</h2>
<h3 id="并发与并行">并发与并行</h3>
<ul>
<li><strong>并发</strong>：在操作系统中，某一时间段内有几个程序在同一个CPU上运行，但<strong>在任意一个时间点上，只有一个程序在CPU上运行</strong></li>
<li><strong>并行</strong>：两个程序在某一时刻同时运行，强调<strong>同时发生</strong></li>
</ul>
<h3 id="进程状态">进程状态</h3>
<ul>
<li><p><strong>创建、就绪、阻塞、运行、终止</strong></p></li>
<li><p><strong>挂起状态</strong>：虚拟内存管理的操作系统中，可能把阻塞状态的进程的物理内存空间换出到硬盘，等需要再次运行时再从硬盘换入到物理内存，描述进程没有占用实际物理内存空间的状态就是挂起状态</p></li>
<li><p><strong>阻塞挂起状态</strong>：进程在外存等待某个事件发生</p></li>
<li><p><strong>就绪挂起状态</strong>：进程在外存中，只要进入内存即可立刻运行</p></li>
</ul>
<h3 id="进程控制块pcb">进程控制块PCB</h3>
<ul>
<li><p><strong>作用</strong>：PCB是进程存在的<strong>唯一标识</strong>，进程创建时PCB创建，进程终止时PCB销毁</p></li>
<li><p>进程描述信息</p>
<p><strong>进程标识符PID</strong>：标识各个进程，每个进程都有一个唯一的标识符</p>
<p><strong>用户标识符UID</strong>：进程归属的用户，为了共享和保护服务</p></li>
<li><p>进程控制和管理信息</p>
<p><strong>进程当前状态</strong>：new、ready、running、waiting或blocked等</p>
<p><strong>进程优先级</strong></p></li>
<li><p><strong>资源</strong>分配清单</p>
<p>有关内存地址空间或虚拟地址空间的信息，所<strong>打开文件的列表</strong>和所<strong>使用的I/O设备信息</strong></p></li>
<li><p>CPU相关信息</p>
<p>CPU中<strong>各个寄存器的值</strong>，当进程切换时，CPU的状态信息被保存在进程的PCB中，以便进程重新执行时，能从断点处继续执行</p></li>
</ul>
<h4 id="pcb是如何组织的">PCB是如何组织的</h4>
<ul>
<li><strong>链表</strong>：通过链表将具有相同状态的进程的PCB链在一起，组成各种队列，如<strong>就绪队列、阻塞队列</strong></li>
</ul>
<h3 id="进程的控制">进程的控制</h3>
<h4 id="创建进程">创建进程</h4>
<ul>
<li><p><strong>创建进程</strong>：操作系统允许一个进程创建另一个进程，且子进程继承父进程所拥有的资源</p></li>
<li><p><strong>过程</strong></p>
<p><strong>分配PID和PCB</strong>：分配新的进程标识号，申请空白的PCB，若申请失败则进程创建失败</p>
<p><strong>分配资源</strong>：为进程分配资源，若资源不足则进程进入等待状态</p>
<p><strong>初始化PCB</strong>：资源分配完成后，初始化PCB</p>
<p><strong>插入就绪队列</strong>：将进程插入到就绪队列，等待被调度</p></li>
</ul>
<h4 id="终止进程">终止进程</h4>
<ul>
<li><strong>查找PCB</strong>：查找需要终止的进程的PCB</li>
<li><strong>终止执行</strong>：若处于执行状态，则立即终止其执行，将CPU资源分配给其他进程</li>
<li><strong>终止子进程</strong>：若该进程有子进程，则子进程也终止</li>
<li><strong>归还资源</strong>：将该进程所拥有的全部资源归还给父进程或操作系统</li>
<li><strong>删除PCB</strong>：将进程PCB从所在队列中删除</li>
</ul>
<h4 id="阻塞进程">阻塞进程</h4>
<ul>
<li><strong>查找PCB</strong>：找到被阻塞进程的PCB</li>
<li><strong>状态转换</strong>：若为运行状态，则保护现场（将CPU寄存器内容保存在PCB等），状态转为阻塞状态</li>
<li><strong>插入阻塞队列</strong>：将PCB插入到阻塞队列</li>
</ul>
<h4 id="唤醒进程">唤醒进程</h4>
<ul>
<li><strong>唤醒</strong>：该进程等待的事件发生，由发现者进程用唤醒语句叫醒阻塞的进程</li>
<li><strong>查找PCB</strong>：在该事件的阻塞队列中找到相应进程的PCB</li>
<li><strong>状态转换</strong>：将PCB从阻塞队列移除，转为就绪状态</li>
<li><strong>插入就绪队列</strong>：PCB插入就绪队列，等待队列</li>
</ul>
<h3 id="进程的上下文切换">进程的上下文切换</h3>
<ul>
<li><p><strong>上下文切换</strong>：从一个进程切换到另一个进程运行的过程</p></li>
<li><p><strong>CPU上下文切换</strong></p>
<p><strong>寄存器和程序计数器</strong>：执行任务前，操作系统需要帮CPU设置好CPU寄存器和程序计数器PC</p>
<p><strong>切换</strong>：将前一个任务的CPU寄存器和PC保存起来，加载新任务的CPU寄存器和PC，跳转到PC所指的新位置运行新任务</p></li>
<li><p><strong>进程上下文切换</strong></p>
<p><strong>进程上下文</strong>：虚拟内存、栈、全局变量等用户空间资源，内核堆栈、寄存器等内核空间资源</p>
<p><strong>存储</strong>：进程上下文信息保存在进程的PCB，当运行时从PCB取出上下文恢复到CPU并继续执行</p></li>
<li><p>进程上下文切换的<strong>场景</strong></p>
<p><strong>时间片耗尽</strong>：CPU采用时间片轮转调度时，当时间片耗尽则进程应从运行态转为就绪态</p>
<p><strong>系统资源不足</strong>：进程需要等待资源满足才可运行，此时它将转换为阻塞态</p>
<p><strong>sleep</strong>：进程通过sleep主动挂起</p>
<p><strong>优先级更高的进程需要运行</strong>：当前运行的进程将被挂起</p>
<p><strong>硬件中断</strong>：CPU上的进程会被中断挂起，转而执行内核中的中断服务程序</p></li>
</ul>
<h2 id="线程">线程</h2>
<ul>
<li><p><strong>概念</strong>：线程是CPU调度的基本单位，同一个进程内的多个线程之间可以<strong>共享代码段、数据段、打开的文件</strong>等资源，每个线程各自都有<strong>独立的寄存器和栈</strong></p></li>
<li><p>优点</p>
<p>一个进程可以同时存在多个线程</p>
<p>各个线程之间可以并发执行</p>
<p>各个线程之间可以共享地址空间和文件等资源</p></li>
<li><p>缺点</p>
<p>进程中的一个线程崩溃时，会导致其所属进程的所有线程崩溃</p></li>
</ul>
<h3 id="进程与线程的比较">进程与线程的比较</h3>
<ul>
<li>进程是资源分配的单位，线程是CPU调度的单位</li>
<li>进程拥有完整的资源，而线程只独享必不可少的资源，如<strong>寄存器和栈</strong></li>
<li>线程同样有<strong>就绪、阻塞、执行三种状态</strong>，以及状态之间的转换关系</li>
<li>线程能<strong>减少并发执行的时间和空间开销</strong></li>
</ul>
<h3 id="线程的开销更小">线程的开销更小</h3>
<ul>
<li><strong>线程创建时间比进程快</strong>，因为线程创建不涉及资源管理信息，而是共享所属进程的资源</li>
<li><strong>线程终止时间比进程快</strong>，因为线程释放的资源比进程少很多</li>
<li><strong>同一个进程内的线程切换比进程切换快</strong>，因为线程具有相同的地址空间（虚拟内存共享），切换时无需切换页表</li>
<li><strong>同一个进程内的线程数据交互效率更高</strong>，同一进程的各个线程之间共享内存和文件资源</li>
</ul>
<h3 id="线程的上下文切换">线程的上下文切换</h3>
<ul>
<li>两个线程属于不同进程时，切换过程与进程上下文切换一致</li>
<li>两个线程属于同一个进程，则虚拟内存等资源无需切换，只需切换线程的寄存器、程序计数器等数据</li>
</ul>
<h3 id="线程的实现">线程的实现</h3>
<ul>
<li><p><strong>用户线程</strong>：用户空间实现的线程，由用户态的线程库完成管理</p></li>
<li><p><strong>内核线程</strong>：内核中实现的线程，由内核管理</p></li>
<li><p><strong>轻量级进程</strong>：在内核中支持用户线程</p></li>
<li><p>用户线程和内核线程的对应关系</p>
<p><strong>多对一</strong>：多个用户线程对应同一个内核线程</p>
<p><strong>一对一</strong>：一个用户线程对应一个内核线程</p>
<p><strong>多对多</strong>：多个用户线程对应多个内核线程</p></li>
<li><p><strong>线程控制块TCB</strong></p></li>
</ul>
<h2 id="进程调度">进程调度</h2>
<h3 id="调度原则">调度原则</h3>
<ul>
<li><strong>CPU利用率</strong></li>
<li><strong>系统吞吐量</strong>：单位时间内CPU完成进程的数量</li>
<li><strong>周转时间</strong>：进程运行和阻塞时间的总和</li>
<li><strong>等待时间</strong>：进程处于就绪队列的时间</li>
<li><strong>响应时间</strong>：从用户提交请求到系统第一次产生响应所花费的时间</li>
</ul>
<h3 id="调度算法">调度算法</h3>
<ul>
<li><p><strong>先来先服务FCFS</strong></p></li>
<li><p><strong>最短作业优先SJF</strong></p></li>
<li><p><strong>高响应比优先算法</strong></p>
<p>优先权=(等待时间+要求服务时间)/要求服务时间</p></li>
<li><p><strong>时间片轮转调度算法</strong></p></li>
<li><p><strong>最高优先级调度算法</strong></p></li>
<li><p><strong>多级反馈队列调度算法</strong></p></li>
</ul>
<h2 id="进程间通信">进程间通信</h2>
<h3 id="管道">管道</h3>
<ul>
<li><strong>Linux命令中的管道</strong>：竖线<code>|</code>将前一个命令的输出作为后一个命令的输入，如下将ps
auxf的输出作为grep mysql的输入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps auxf | grep mysql</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>单向</strong>：管道传输数据是单向的，如果想相互通信需要创建两个管道</p></li>
<li><p><strong>匿名管道</strong>：<code>|</code>表示的管道称为匿名管道，用完了就销毁</p></li>
<li><p><strong>命名管道</strong>：也叫做<code>FIFO</code>，因为数据是先进先出的传输方式。通过<code>mkfifo</code>命令创建并指定管道名字，命名管道以文件的方式存在，类型为p（pipe）</p></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkfifo myPipe</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; myPipe	// 将数据写进管道</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt; myPipe			// 读取管道数据</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<h4 id="匿名管道创建的原理">匿名管道创建的原理</h4>
<ul>
<li><strong>pipe系统调用</strong>：返回两个描述符，分别是管道的读取端描述符<code>fd[0]</code>，另一个是管道的写入端描述符<code>fd[1]</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe</span><span class="params">(<span class="keyword">int</span> fd[<span class="number">2</span>])</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>管道是内核里的一段缓存</strong>：写入管道的数据实际上是缓存在内核中的，从管道读取数据实则从内核中读取数据</li>
</ul>
<h4 id="父子进程通信">父子进程通信</h4>
<ul>
<li><strong>管道描述符复制</strong>：父进程使用fork创建子进程，子进程会复制父进程的文件描述符，因此子进程也拥有该管道的读取端、写入端的描述符</li>
<li><strong>单向通信</strong>：父进程关闭读取端描述符<code>fd[0]</code>，保留写入端<code>fd[1]</code>；子进程关闭写入端<code>fd[1]</code>，保留读取端<code>fd[0]</code>，这样父进程往管道写入的数据就能被子进程读取</li>
<li><strong>双向通信</strong>：如果需要双向通信，则应该创建两个管道</li>
</ul>
<h4 id="匿名管道和命名管道的区别">匿名管道和命名管道的区别</h4>
<ul>
<li><p><strong>匿名管道</strong>：<strong>通信范围</strong>是存在<strong>父子关系的进程</strong>，管道没有实体，没有管道文件，因此该管道只能通过fork复制父进程文件描述符，来达到通信的目的</p></li>
<li><p><strong>命名管道</strong>：可以在<strong>不相关的进程</strong>间相互通信，命名管道创建了类型为管道的设备文件，进程只要使用这个设备文件，就可以相互通信</p></li>
<li><p><strong>共同点</strong>：数据都是缓存在内核中，数据遵循FIFO原则</p></li>
</ul>
<h3 id="消息队列">消息队列</h3>
<ul>
<li><p><strong>链表</strong>：消息队列是保存在内核中的消息链表，发送数据时会分成多个独立的数据单元，即消息体。进程从消息队列中读取了消息体，内核就把该消息体删除</p></li>
<li><p><strong>消息队列不阻塞进程</strong>：A进程要给B进程发送消息，则A进程只要把数据放在对应的消息队列后就可正常返回，B进程需要的时候再去读取数据即可</p></li>
<li><p><strong>消息队列存在用户态与内核态之间的数据拷贝开销</strong>：进程写入数据到内核中的消息队列时，需要把数据从用户态拷贝到内核态；进程读取消息队列的数据时，需要将数据从内核态拷贝到用户态</p></li>
</ul>
<h3 id="共享内存">共享内存</h3>
<ul>
<li><p><strong>优点</strong>：消息队列在进行读取和写入时，都得进行内核态与用户态之间的数据拷贝，共享内存则解决了该问题</p></li>
<li><p><strong>虚拟内存</strong>：每个进程都有独立的虚拟内存空间，不同进程的虚拟内存映射到不同的物理内存，因此两个进程相同的虚拟地址对应着不同的物理内存地址</p></li>
<li><p><strong>共享内存</strong>：将一块虚拟地址空间映射到相同的物理内存中，进程A写入的内容将立刻被进程B看见，无需进行拷贝，大大提高了进程间通信的速度</p></li>
</ul>
<h3 id="信号量">信号量</h3>
<ul>
<li><p><strong>共享内存的问题</strong>：如果多个进程同时修改同一个共享内存，则部分进程的修改将被其他进程覆盖，造成数据错乱</p></li>
<li><p><strong>保护机制</strong>：为了防止多进程竞争共享资源，造成数据错乱，需要保护机制，是的共享资源在任意时刻只能被一个进程访问</p></li>
<li><p><strong>信号量</strong>：一个整型的计数器，主要用于实现进程间的互斥与同步</p></li>
<li><p><strong>控制信号量的两种原子操作</strong></p>
<p><strong>P操作</strong>：把信号量减去1，相减后若信号量小于0，则表明资源已被占用，进程需要阻塞等待；若相减后信号量大于等于0，则表明还有资源可用，进程可正常继续执行</p>
<p><strong>V操作</strong>：把信号量加上1，相加后若信号量小于等于0，则表明当前有阻塞中的进程，于是会将该进程唤醒运行；相加后如果信号量大于0，则表明没有阻塞中的进程</p></li>
<li><p><strong>互斥信号量</strong>：<strong>信号初始化为1</strong>，则保证共享资源在任何时刻只有一个进程在访问，因此为互斥信号量</p></li>
<li><p><strong>同步信号量</strong>：<strong>信号初始化为0</strong>，假如必须保证进程A在进程B之前执行，则进程A在最后执行V操作，进程B在最开始执行P操作</p></li>
</ul>
<h3 id="信号">信号</h3>
<ul>
<li><p><strong>信号</strong>：<strong>异常情况</strong>下，需要用信号的方式通知进程</p></li>
<li><p><strong>Linux信号</strong></p>
<p>对于运行在shell终端的进程，可以通过键盘输入某些组合键给进程发送信号，如</p>
<p><strong>终止进程</strong>：Ctrl+C产生SIGINT信号，表示终止进程</p>
<p><strong>停止进程</strong>：Ctrl+Z产生SIGTSTP信号，表示停止进程，但还未结束</p>
<p>如果进程在后台运行，可以通过<strong>kill命令和进程PID</strong>给进程发送信号，如</p>
<p><code>kill -9 1050</code>，表示给PID为1050的进程发送SIGKILL信号，用来立即结束该进程</p></li>
</ul>
<h3 id="socket">Socket</h3>
<ul>
<li><p><strong>Socket通信</strong>：跨网络与不同主机上的进程之间通信，也可以在同主机上进程间通信</p></li>
<li><p>创建socket的系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>
<p>domain指定协议族，比如AF_INET用于IPv4，AF_INET6用于IPv6，AF_LOCAL用于本机</p>
<p>type指定通信特性，如SOCK_STREAM表示字节流，对应TCP；SOCK_DGRAM表示数据报，对应UDP；SOCK_RAW表示原始套接字</p>
<p>protocol用于指定通信协议，现在基本废弃</p></li>
</ul>
<h4 id="基于tcp协议通信的socket编程模型">基于TCP协议通信的socket编程模型</h4>
<ul>
<li><p>过程</p>
<p><strong>初始化socket</strong>：服务端和客户端初始化socket，得到文件描述符</p>
<p><strong>绑定</strong>：服务端调用bind，绑定在IP地址和端口</p>
<p><strong>监听</strong>：服务端调用listen进行监听</p>
<p><strong>accept</strong>：服务端调用accept等待客户端连接，客户端发起连接后，accept返回用于传输的socket的文件描述符</p>
<p><strong>发起连接</strong>：客户端调用connect向服务端的地址和端口发起连接请求</p>
<p><strong>数据传输</strong>：客户端调用write写入数据，服务端调用read读取数据</p>
<p><strong>断开连接</strong>：客户端调用close，服务器调用read读取数据时会读取到EOF，处理完数据后服务端调用close表示连接关闭</p></li>
<li><p>两个socket</p>
<p><strong>监听socket</strong>：服务端进行监听的socket</p>
<p><strong>已完成连接socket</strong>：用于传送数据的socket</p></li>
</ul>
<h4 id="基于udp协议通信的socket编程模型">基于UDP协议通信的socket编程模型</h4>
<ul>
<li><strong>初始化socket</strong></li>
<li><strong>绑定</strong>：每个UDP的socket都需要绑定IP地址和端口</li>
<li><strong>sendto</strong>：向目标主机的IP地址和端口发送数据</li>
<li><strong>recvfrom</strong>：接收源主机IP地址和端口的数据</li>
<li><strong>无连接</strong>：UDP是无连接的，因此不需要三次握手，也不需要调用listen和connect</li>
</ul>
<h4 id="针对本地进程间通信的socket编程模型">针对本地进程间通信的socket编程模型、</h4>
<ul>
<li><strong>效率提高</strong>：编程接口和IPv4、IPv6套接字编程接口一致，支持字节流、数据报两种协议，但实现效率大大提高</li>
<li><strong>绑定</strong>：本地字节流socket和本地数据报socket在bind时，并非<strong>绑定IP地址和端口</strong>，而是<strong>绑定本地文件</strong></li>
</ul>
<h2 id="多线程同步">多线程同步</h2>
<h3 id="互斥">互斥</h3>
<ul>
<li><p><strong>race
condition</strong>：多线程相互竞争操作共享变量时，由于在执行过程中发生了上下文切换，得到了错误的结果</p></li>
<li><p><strong>临界区</strong>：访问共享资源的代码片段，不能给多线程同时执行</p></li>
<li><p><strong>互斥</strong>：一个线程在临界区执行时，其他线程应该被阻止进入临界区</p></li>
</ul>
<h3 id="同步">同步</h3>
<ul>
<li><strong>同步</strong>：并发进程/线程在一些关键点上可能需要互相等待与互通消息，这种相互制约的等待与互通消息称为进程/线程同步。即多个进程/线程在合作共同完成任务时，需要有一定的先后执行顺序的制约。</li>
</ul>
<h3 id="互斥与同步的实现和使用">互斥与同步的实现和使用</h3>
<h4 id="锁">锁</h4>
<ul>
<li><p><strong>加锁</strong>：任何进入临界区的线程，必须先执行加锁操作，加锁成功则进入临界区，否则阻塞</p></li>
<li><p><strong>解锁</strong>：完成对临界资源的访问后执行解锁操作，以释放该临界资源</p></li>
<li><p><strong>原子操作指令Test-and-Set</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">TestAndSet</span><span class="params">(<span class="keyword">int</span> *old_ptr, <span class="keyword">int</span> <span class="keyword">new</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> old = *old_ptr;</span><br><span class="line">    *old_ptr = <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>功能</strong>：该指令由硬件完成，把old_ptr更新为new的值，并返回old_ptr的旧值</p>
<p><strong>原子性</strong>：要么全部执行，要么都不执行，不会出现执行到一半的中间状态</p></li>
<li><p><strong>使用原子操作指令实现忙等待锁</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> flag;</span><br><span class="line">&#125; <span class="keyword">lock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">lock_t</span> *lock)</span> </span>&#123;</span><br><span class="line">    lock-&gt;flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">lock_t</span> *lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (TestAndSet(&amp;lock-&gt;flag, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">    ;	<span class="comment">// do nothing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">lock_t</span> *lock)</span> </span>&#123;</span><br><span class="line">   	lock-&gt;flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>flag的含义</strong>：flag为1代表该锁被某个线程持有，否则代表该锁未被持有</p>
<p><strong>加锁时的操作</strong>：假如该锁已被其他线程持有，则<code>lock-&gt;flag</code>为1，执行<code>TestAndSet(&amp;lock-&gt;flag, 1)</code>不会改变flag的值，而且会读取到1，此时while循环条件满足，将继续循环；若该锁被其他线程释放，则<code>lock-&gt;flag</code>为0，执行<code>TestAndSet(&amp;lock-&gt;flag, 0)</code>会改变flag的值，从而获取该锁，同时读取到原来的值0，将跳出循环，并执行临界区代码</p></li>
<li><p><strong>自旋锁</strong>：当获取不到锁时，线程会一直执行while循环而不做任何其他事情，因此称为忙等待锁，也叫自旋锁spin
lock</p></li>
<li><p><strong>无等待锁</strong>：获取不到锁时，线程放入到锁的等待队列，当前线程阻塞，CPU会调度其他线程执行。待持有锁的线程释放锁时，将唤醒该锁的等待队列中的某个线程让其获取锁并继续执行</p></li>
</ul>
<h4 id="信号量-1">信号量</h4>
<ul>
<li><p><strong>含义</strong>：信号量通常表示资源的数量，对应一个整型变量</p></li>
<li><p><strong>原子操作</strong></p>
<p><strong>P操作</strong>：将信号量减1，若<strong>信号量小于0则阻塞等待</strong>，否则继续执行</p>
<p><strong>V操作</strong>：将信号量加1，若<strong>信号量小于等于0则唤醒一个等待中的线程/进程</strong></p></li>
</ul>
<h3 id="c实现信号量机制">C++实现信号量机制</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unique_lock&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    mutex mtx;</span><br><span class="line">    condition_variable cv;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Semaphore</span>(<span class="keyword">int</span> count = <span class="number">1</span>): <span class="built_in">count</span>(cnt) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">guard</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        <span class="keyword">while</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">        	cv.<span class="built_in">wait</span>(guard);</span><br><span class="line">       	--count;        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">guard</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        ++count;</span><br><span class="line">        cv.<span class="built_in">notify_all</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="生产者-消费者问题">生产者-消费者问题</h3>
<ul>
<li><p><strong>问题描述</strong>：生产者生成数据后，放在缓冲区中；消费者从缓冲区取出数据处理；任何时刻，只能有一个生产者或消费者可以访问缓冲区</p></li>
<li><p>问题分析</p>
<p><strong>互斥访问缓冲区</strong>：任何时刻只有一个线程能访问缓冲区，需要设置互斥信号量保护缓冲区</p>
<p><strong>缓冲区空</strong>：消费者必须等待生产者生成数据</p>
<p><strong>缓冲区满</strong>：生产者必须等待消费者取出数据</p></li>
<li><p>信号量设置</p>
<p><strong>互斥信号量mutex</strong>：用于互斥访问缓冲区，初始化值为1</p>
<p><strong>资源信号量full</strong>：用于消费者询问缓冲区是否有数据，有数据则读取，无数据则阻塞，初始化为0（表示缓冲区初始为空）</p>
<p><strong>资源信号量empty</strong>：用于生产者询问缓冲区是否有空位，有空位则生成数据，初始化值为n（缓冲区大小）</p></li>
<li><p>实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> N = <span class="number">10</span>;	<span class="comment">// buffer size</span></span><br><span class="line"><span class="function">Semaphore <span class="title">mutex</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="function">Semaphore <span class="title">full</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="function">Semaphore <span class="title">empty</span><span class="params">(N)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(full);</span><br><span class="line">        P(mutex);</span><br><span class="line">        read();</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(empty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;     </span><br><span class="line">        P(empty);</span><br><span class="line">        P(mutex);</span><br><span class="line">        write();</span><br><span class="line">        V(mutex);</span><br><span class="line">        V(full);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>先获取full或empty信号量，再获取互斥锁mutex</strong>：如果先获取mutex则会导致死锁，假设当前缓冲区为空，消费者获取了mutex，然后尝试获取full失败并阻塞，但它仍然持有mutex。此时，生产者想要生成数据必须先获取mutex，由于已被持有因此生产者也会被阻塞，造成死锁</p></li>
</ul>
<h3 id="哲学家进餐问题">哲学家进餐问题</h3>
<ul>
<li>限制就餐人数为N-1</li>
<li>指定拿筷子规则，奇数哲学家先拿左手，偶数哲学家先拿右手</li>
</ul>
<h3 id="读者-写者问题">读者-写者问题</h3>
<ul>
<li><p><strong>问题描述</strong>：多个读者可以共同访问，但是写者必须单独访问（不能与其他读者共同访问，也不能与其他写者共同访问）</p></li>
<li><p><strong>实现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Semaphore <span class="title">rMutex</span><span class="params">(<span class="number">1</span>)</span></span>;		<span class="comment">// 访问读者计数器rCount的互斥量</span></span><br><span class="line"><span class="function">Semaphore <span class="title">wMutex</span><span class="params">(<span class="number">1</span>)</span></span>;		<span class="comment">// 读者与写者互斥访问文件的互斥量</span></span><br><span class="line"><span class="function">Semaphore <span class="title">flag</span><span class="params">(<span class="number">1</span>)</span></span>;			<span class="comment">// 读者与写者互斥访问wMutex的互斥量</span></span><br><span class="line"><span class="keyword">int</span> rCount = <span class="number">0</span>;				<span class="comment">// 读者计数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(flag);</span><br><span class="line">        P(wMutex);</span><br><span class="line">        write();</span><br><span class="line">        V(wMutex);</span><br><span class="line">        V(flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        P(flag);</span><br><span class="line">        P(rMutex);</span><br><span class="line">        <span class="keyword">if</span> (rCount == <span class="number">0</span>) &#123;</span><br><span class="line">            P(wMutex);			<span class="comment">// 第一个读者进入时, 需要阻塞写者写操作</span></span><br><span class="line">        &#125;</span><br><span class="line">        ++rCount;</span><br><span class="line">        V(rMutex);</span><br><span class="line">        V(flag);</span><br><span class="line">        read();</span><br><span class="line">        P(rMutex);</span><br><span class="line">        --rCount;</span><br><span class="line">        <span class="keyword">if</span> (rCount == <span class="number">0</span>) &#123;</span><br><span class="line">            V(wMutex);			<span class="comment">// 没有读者了, 唤醒阻塞中的写者</span></span><br><span class="line">        &#125;</span><br><span class="line">        V(rMutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="死锁">死锁</h2>
<h3 id="死锁的必要条件">死锁的必要条件</h3>
<ul>
<li>互斥访问</li>
<li>不可抢占</li>
<li>占有并等待</li>
<li>环路等待</li>
</ul>
<h3 id="解决方法">解决方法</h3>
<ul>
<li>死锁预防</li>
<li>死锁检测与恢复</li>
<li>死锁避免：银行家算法</li>
</ul>
<h2 id="锁-1">锁</h2>
<h3 id="互斥锁与自旋锁">互斥锁与自旋锁</h3>
<ul>
<li><p><strong>互斥锁</strong>：加锁失败后，线程<strong>释放CPU</strong>给其他线程</p></li>
<li><p><strong>自旋锁</strong>：加锁失败后，线程会忙等待（<strong>占用CPU</strong>），直到拿到锁</p></li>
<li><p><strong>互斥锁的开销成本</strong>：当线程获取互斥锁失败时将被阻塞，线程从运行切换为阻塞状态，从用户态陷入内核态，内核完成线程切换；当该互斥锁被其他线程释放时，之前睡眠的线程变为就绪状态，内核会在合适的时间把CPU切换到该线程运行。因此互斥锁的开销成本为两次线程上下文切换的成本</p></li>
<li><p><strong>自旋锁的开销成本</strong>：自旋锁通过CPU提供的CAS函数（Compare
And
Swap）在用户态完成加锁和解锁操作，无需进行线程上下文切换，但是会一直占用CPU</p></li>
<li><p><strong>选择</strong>：如果临界区代码执行时间很短，则不应该用互斥锁，而是用自旋锁；若临界区代码执行时间较长，则使用互斥锁，因为此时使用自旋锁将导致较长时间内CPU资源的浪费</p></li>
</ul>
<h3 id="读写锁">读写锁</h3>
<ul>
<li><strong>原理</strong>：写锁是独占锁，读锁是共享锁</li>
<li><strong>应用</strong>：读写锁在读多写少的场景，能发挥出优势</li>
</ul>
<h3 id="乐观锁与悲观锁">乐观锁与悲观锁</h3>
<ul>
<li><strong>悲观锁</strong>：认为多线程同时修改共享资源的概率较高，很容易出现冲突，所以<strong>访问共享资源前先上锁</strong></li>
<li><strong>乐观锁</strong>：认为多线程同时修改共享资源的概率较低。<strong>先修改</strong>共享资源，<strong>再验证</strong>这段时间内有没有发生冲突，如果没有其他线程修改资源则操作完成，否则<strong>放弃本次操作并重试</strong></li>
</ul>
<h1 id="调度算法-1">调度算法</h1>
<h2 id="进程调度算法">进程调度算法</h2>
<ul>
<li>先来先服务调度算法FCFS</li>
<li>最短作业优先调度算法SJF</li>
<li>高响应比优先调度算法</li>
<li>时间片轮转调度算法</li>
<li>最高优先级调度算法</li>
<li>多级反馈队列调度算法</li>
</ul>
<h2 id="页面置换算法">页面置换算法</h2>
<h3 id="缺页中断">缺页中断</h3>
<ul>
<li><p><strong>缺页中断</strong>：当CPU访问的页面不在物理内存时，则产生一个缺页中断，请求操作系统将所缺页调入到物理内存</p></li>
<li><p>缺页中断的处理流程</p>
<p><strong>执行指令</strong>：Load M指令，CPU寻找M对应的页表项</p>
<p><strong>页表项无效，发出缺页中断</strong>：如果该页表项的状态位是无效的，则CPU发送缺页中断请求</p>
<p><strong>缺页中断处理函数</strong>：操作系统收到缺页中断，执行缺页中断处理函数，查找该页面在磁盘中的页面的位置</p>
<p><strong>换入</strong>：在物理内存中找到空闲页，把该页面从磁盘换入到内存中</p>
<p><strong>修改页表项为有效的</strong>：把该页的页表项的有效位修改为有效的</p>
<p><strong>重新执行指令</strong>：CPU重新执行导致缺页异常的指令</p></li>
<li><p><strong>页面置换</strong>：物理内存没有空闲页时，则需要进行页面置换，选择一个物理页，若其dirty位置位，则换出到磁盘，并将其页表项改为无效的。然后把需要访问的页从磁盘换入到物理内存</p></li>
<li><p><strong>页表项：页号、物理页号、有效位、访问字段、dirty位、硬盘地址</strong></p></li>
</ul>
<h3 id="虚拟内存访存的整体流程">虚拟内存访存的整体流程</h3>
<ul>
<li><strong>检查虚拟地址</strong>：程序通过虚拟地址访问某个页面，先检查该地址是否有效</li>
<li><strong>检索TLB、访问页表</strong>：若有效则检索TLB，TLB命中则得到了该页表项；否则访问页表，并将该页表项更新至TLB</li>
<li><strong>检查页表项有效位、缺页中断</strong>：检查该页表项有效位，若无效则发送缺页中断，由操作系统从磁盘中找到缺页并换入内存，若需要进行页面置换则检查该页面是否dirty，若是还需要将其写入磁盘</li>
<li><strong>置访问位、dirty位</strong>：修改该页的页表项的访问位和dirty位</li>
<li><strong>得到物理地址</strong>：将物理页号和页内偏移量组合得到物理地址，最后访问该地址</li>
</ul>
<h3 id="页面置换算法-1">页面置换算法</h3>
<ul>
<li><strong>最佳页面置换算法OPT</strong></li>
<li><strong>先进先出置换算法FIFO</strong></li>
<li><strong>最近最久未使用LRU</strong></li>
<li><strong>时钟页面置换算法Lock</strong></li>
<li><strong>最不常用置换算法LFU</strong></li>
</ul>
<h1 id="io模型">I/O模型</h1>
<ul>
<li><p>一个输入操作通常包括<strong>两个阶段</strong></p>
<p><strong>等待数据到来</strong>：等待数据准备好</p>
<p><strong>拷贝数据</strong>：从内核向进程复制数据</p></li>
<li><p>对于套接字上输入操作的两个阶段</p>
<p><strong>等待数据从网络到来</strong>：等待数据从网络中到达，到达后数据被复制到内核中的某个缓冲区</p>
<p><strong>拷贝数据</strong>：把数据从内核缓冲区复制到应用进程缓冲区</p></li>
</ul>
<h2 id="阻塞io">阻塞I/O</h2>
<ul>
<li>应用进程被阻塞，直至<strong>数据从内核缓冲区复制到应用进程缓冲区</strong>才返回</li>
<li>阻塞时，CPU调度将执行其他线程/进程</li>
</ul>
<h2 id="非阻塞io">非阻塞I/O</h2>
<ul>
<li><p><strong>轮询</strong>：应用进程执行系统调用后，内核返回一个错误码，应用进程可以继续执行，但是需要<strong>不断执行系统调用以获知I/O是否完成</strong></p></li>
<li><p><strong>缺点</strong>：应用进程需要进行多次系统调用，<strong>CPU利用率较低</strong></p></li>
</ul>
<h2 id="io复用">I/O复用</h2>
<ul>
<li><p><strong>等待数据</strong>：使用select或poll等待数据，等待多个套接字中的任何一个变为可读，此过程会被阻塞</p></li>
<li><p><strong>读取数据</strong>：某一个套接字可读时返回，使用<code>recvfrom</code>系统调用把数据从内核复制到进程中</p></li>
<li><p><strong>优点</strong>：单个进程具有处理多个I/O事件的能力，又称为事件驱动I/O</p></li>
</ul>
<h2 id="信号驱动io">信号驱动I/O</h2>
<ul>
<li><strong>sigaction系统调用</strong>：应用进程使用sigaction系统调用，内核立刻返回，等待数据阶段是非阻塞的</li>
<li><strong>数据到达</strong>：内核在数据到达时向应用进程发送SIGIO信号，应用进程收到后在信号处理程序中调用recvfrom将数据从内核复制到应用进程中</li>
<li><strong>优点</strong>：相比于非阻塞式的I/O轮询方式，提高了CPU利用率</li>
</ul>
<h2 id="异步io">异步I/O</h2>
<ul>
<li><p><strong>aio_read系统调用</strong>：应用进程执行aio_read系统调用后立即返回，应用进程可以继续执行，不会被阻塞，内核会在所有操作完成后向应用进程发送信号</p></li>
<li><p><strong>异步I/O与信号驱动I/O的区别</strong></p>
<p>异步I/O的信号是<strong>通知应用进程I/O完成</strong>（数据已经复制到应用进程缓冲区）</p>
<p>信号驱动I/O的信号是<strong>通知应用进程可以开始I/O</strong>（数据已经到达内核缓冲区，需要调用recv_from将数据拷贝到应用进程缓冲区）</p></li>
</ul>
<h2 id="同步io与异步io的区别">同步I/O与异步I/O的区别</h2>
<ul>
<li><strong>同步I/O</strong>：将数据从内核缓冲区复制到应用进程缓冲区阶段，应用进程会被阻塞</li>
<li><strong>异步I/O</strong>：上述第二阶段不会被阻塞</li>
</ul>
<h2 id="io多路复用">I/O多路复用</h2>
<h3 id="select">select</h3>
<ul>
<li><p><strong>功能</strong>：允许应用程序监视一组文件描述符，等待一个或多个描述符称为就绪状态，从而完成I/O操作</p></li>
<li><p><strong>参数</strong></p>
<p>fd_set：文件描述符集合，使用数组实现，数组大小固定为FD_SETSIZE（Linux中为1024）。三种类型的描述符类型为readset、writeset、exceptset，分别对应读、写、异常条件的描述符集合</p>
<p>timeout：超时参数，调用select会一直阻塞直到有描述符的时间到达，或等待的时间超过了timeout</p></li>
<li><p><strong>返回值</strong>：调用成功返回结果大于0，超时返回0，出错返回-1</p></li>
</ul>
<h3 id="poll">poll</h3>
<ul>
<li><p><strong>功能</strong>：poll的功能与select类似，也是等待一组描述符中的任意一个成为就绪状态</p></li>
<li><p><strong>描述符数量限制</strong>：select使用数组实现文件描述符集合，数组大小为1024，poll没有描述符数量限制</p></li>
<li><p>缺点</p>
<p><strong>速度较慢</strong>，每次调用都需要将全部描述符从应用进程缓冲区复制到内核缓冲区</p></li>
</ul>
<h3 id="epoll">epoll</h3>
<ul>
<li><p>接口</p>
<p><code>epoll_create</code>用于让内核创建一组大小为size的文件描述符集合</p>
<p><code>epoll_ctl</code>用于向内核注册新的描述符或改变某个文件描述符的状态</p>
<p><code>epoll_wait</code>获取事件完成的文件描述符集合</p></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>数据结构</strong>：已注册的描述符在内核中被维护在一棵<strong>红黑树</strong>上，通过回调函数，内核会将I/O已准备好的描述符加入到一个<strong>链表</strong>中管理，通过epoll_wait系统调用就能得到事件完成的文件描述符集合</p></li>
<li><p><strong>触发模式</strong></p>
<p><strong>水平触发level
trigger</strong>：调用epoll_wait检测到描述符事件到达时，将事件通知进程，进程可以不立即处理该事件，下次调用epoll_wait时会再次通知进程</p>
<p><strong>边沿触发edge
trigger</strong>：描述符事件到达后，通知进程，进程必须立即处理事件，否则下次再次调用epoll_wait不会再得到事件到达的通知</p></li>
<li><p>优缺点</p>
<p><strong>优点</strong>：所有文件描述符都存在于内核中，<strong>无需</strong>进行从用户进程缓存到内核缓存的文件描述符集合<strong>拷贝</strong></p>
<p><strong>缺点</strong>：每次<strong>修改</strong>文件描述符状态都需要<strong>通过epoll_ctl()系统调用</strong></p></li>
</ul>
<h3 id="比较">比较</h3>
<ul>
<li><strong>时间精度</strong>：select的时间精度为微秒，而poll和epoll为毫秒，因此<strong>select适用于实时性要求更高的场景</strong></li>
<li><strong>描述符数量限制</strong>：select上限为1024，poll和epoll无限制</li>
<li><strong>文件描述符存储位置</strong>：select和poll存储在用户进程，每次系统调用都需要进行从用户进程缓冲区到内核缓冲区的拷贝，epoll存储在内核。因此如果需要<strong>监听处理大量文件描述符时，使用epoll效率更高</strong></li>
<li><strong>可移植性</strong>：select几乎被所有主流平台所支持，epoll只能运行在linux平台</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E5%9B%BE%E8%A7%A3%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Young">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="元朗食品">
      <meta itemprop="description" content="Talk is cheap, show me the code.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 元朗食品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/24/%E5%9B%BE%E8%A7%A3%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">图解网络笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-24 10:23:21" itemprop="dateCreated datePublished" datetime="2022-03-24T10:23:21+08:00">2022-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-08 20:08:32" itemprop="dateModified" datetime="2022-04-08T20:08:32+08:00">2022-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Network/" itemprop="url" rel="index"><span itemprop="name">Computer Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="http1.1">HTTP/1.1</h1>
<h2 id="无状态">无状态</h2>
<ul>
<li><p><strong>优点</strong>：服务器不记忆HTTP状态，不需要额外资源记录状态信息，<strong>减轻服务器的负担</strong></p></li>
<li><p><strong>缺点</strong>：进行<strong>关联性操作</strong>时非常麻烦，如对于购物网站，登录、添加购物车、下单、结算、支付等系列操作都需要知道用户身份，若无状态则服务器每次都需要询问身份信息</p></li>
<li><p><strong>Cookie工作原理</strong></p>
<p><strong>Cookie</strong>：服务器发送到浏览器并保存在浏览器本地的一小块数据</p>
<p><strong>Set-Cookie</strong>：服务器发送的HTTP响应报文包含<strong>Set-Cookie首部字段</strong>，字段内容是Cookie的数据</p>
<p><strong>携带Cookie</strong>：浏览器之后向同一服务器再次发起请求时会携带该Cookie数据，并放在HTTP请求报文的<strong>Cookie首部字段</strong></p></li>
</ul>
<h2 id="不安全">不安全</h2>
<ul>
<li><strong>明文</strong>：通信使用明文（不加密），内容可能会被<strong>窃听</strong></li>
<li><strong>无身份验证</strong>：不验证通信方的身份，可能遭遇<strong>伪装</strong></li>
<li><strong>无完整性保护</strong>：无法证明报文的完整性，所以可能遭遇<strong>篡改</strong></li>
</ul>
<h2 id="长连接">长连接</h2>
<ul>
<li><strong>HTTP1.0默认使用短链接</strong>：每个请求-响应对都建立一个TCP连接</li>
<li><strong>HTTP1.1默认使用长连接</strong>：只要任意一端没有明确提出断开连接，则保持TCP连接状态</li>
</ul>
<h2 id="管道传输网络">管道传输网络</h2>
<ul>
<li><strong>管道</strong>：在同一个TCP连接里面，客户端可以发起多个HTTP请求，不必等第一个请求响应，即可发出第二个请求，减少整体响应时间</li>
<li><strong>服务器按顺序处理</strong>：尽管客户端可以发送多个请求，服务器还是按照顺序响应，若前面的响应特别慢，就会导致后面的请求排队等候，称为<strong>队头堵塞</strong></li>
<li><strong>队头堵塞</strong>：顺序发送的请求序列中一个请求因某种原因被阻塞时，后面排队的所有请求
也一同被阻塞</li>
</ul>
<h1 id="https">HTTPS</h1>
<h2 id="http与https的区别">HTTP与HTTPS的区别</h2>
<ul>
<li><strong>加密</strong>：HTTP使用明文传输，存在安全风险；HTTPS在HTTP和TCP之间加入了SSL/TLS安全协议，使得报文能够加密传输</li>
<li><strong>连接建立过程</strong>：HTTP只需要经过TCP三次握手，即可进行HTTP报文传输；HTTPS在TCP三次握手后，还需要进行SSL/TLS握手过程，才可进行加密报文传输</li>
<li><strong>端口号</strong>：HTTP端口号是80，HTTPS端口号是443</li>
<li><strong>认证</strong>：HTTPS协议需要向CA（证书权威机构）申请数字证书，保证服务器身份可信</li>
</ul>
<h2 id="https解决了http的哪些问题">HTTPS解决了HTTP的哪些问题</h2>
<ul>
<li><p>HTTP的安全风险</p>
<p><strong>窃听风险</strong>：HTTP采用明文传输，攻击者可能从通信链路上获取通信内容</p>
<p><strong>篡改风险</strong>：HTTP没有完整性保护，攻击者可能篡改报文信息</p>
<p><strong>冒充风险</strong>：HTTP没有认证，攻击者可能伪造身份</p></li>
<li><p>HTTPS在HTTP与TCP之间加入了SSL/TLS协议，解决了上述风险</p>
<p><strong>加密</strong>：通过混合加密的方式保证信息的机密性，解决了窃听的风险</p>
<p><strong>认证</strong>：通过数字证书签名机制，认证身份</p>
<p><strong>完整性保护</strong>：通过摘要算法，为数据生成独一无二的指纹，校验数据的完整性，解决了篡改的风险</p></li>
</ul>
<h3 id="混合加密">混合加密</h3>
<ul>
<li><strong>非对称加密</strong>：通信建立前采用非对称加密方式交换“会话密钥”</li>
<li><strong>对称加密</strong>：通信过程中使用对称加密的会话密钥加密明文数据</li>
</ul>
<h3 id="摘要算法">摘要算法</h3>
<ul>
<li><strong>发送方计算指纹</strong>：客户端在发送前通过摘要算法算出明文的“指纹”，发送时把“指纹+明文”一同加密后发送</li>
<li><strong>接收方计算指纹并比对</strong>：服务器解密后，用相同的摘要算法算出发送过来的明文的”指纹“，并与客户端携带的”指纹“进行对比，若两者相同则数据完整</li>
</ul>
<h3 id="数字证书">数字证书</h3>
<ul>
<li>公钥不被篡改：通信建立前，客户端需要用服务器发来的公钥对会话密钥进行加密，客户端如何保证该公钥的确是由服务器发送的，且未被篡改呢？</li>
<li><strong>服务器向CA注册</strong>：客户端</li>
<li>与服务器都信任的第三方机构，服务端将自己的公钥注册到CA，CA会用CA私钥对服务端公钥进行加密得到数字签名</li>
<li><strong>CA颁发数字证书</strong>：CA将数字签名与服务器公钥一起放入数字证书，并发送给服务器</li>
<li><strong>服务器发送数字证书</strong>：服务器将CA颁发的数字证书发送给客户端，里面包含服务器公钥，以及CA对该公钥的数字签名</li>
<li><strong>客户端进行认证</strong>：客户端浏览器或操作系统已经内置了CA的公钥，客户收到数字证书后，将数字签名用CA公钥解密，并比对解密后的服务器公钥与数字证书中的服务器公钥是否匹配，若匹配则认证成功</li>
</ul>
<h2 id="ssltls的四次握手过程">SSL/TLS的四次握手过程</h2>
<ul>
<li><p><code>ClientHello</code>：客户端向服务器发起加密通信请求，告诉服务器自己</p>
<p>所支持的<strong>SSL/TLS协议版本</strong></p>
<p>所生成的<strong>随机数</strong>（Client
Random，用于生成会话密钥）</p>
<p>所支持的<strong>密码套件列表</strong>，如RSA加密算法</p></li>
<li><p><code>ServerHello</code>：服务器收到客户端请求后进行响应，包含内容</p>
<p>确认<strong>SSL/TLS协议版本</strong></p>
<p>服务器生成的<strong>随机数</strong>（Server
Random，用于生成会话密钥）</p>
<p>确认<strong>密码套件列表</strong></p>
<p>服务器的<strong>数字证书</strong></p></li>
<li><p><strong>客户端回应</strong>：收到Server
Hello后，客户端通过CA公钥解密数字签名，确认数字证书真实性，认证后从数字证书取出服务器公钥，发送以下信息</p>
<p>经服务器公钥加密的<strong>随机数</strong></p>
<p>加密通信算法改变通知，表示随后信息都将用“会话密钥”加密通信</p>
<p>客户端握手结束通知，表示客户端的握手阶段已结束</p>
<blockquote>
<p>整个握手过程中，客户端和服务器总共生成了<strong>三个随机数</strong>，且双方都知道这三个随机数，它们会用协商的加密算法，各自生成本次通信的会话密钥</p>
</blockquote></li>
<li><p><strong>服务器回应</strong>：服务器收到客户端的第三个随机数后，通过协商的加密算法，计算出本次通信的”会话密钥“，发送以下信息</p>
<p>加密通信算法改变通知</p>
<p>服务器握手结束通知</p></li>
</ul>
<h1 id="http2">HTTP/2</h1>
<h2 id="头部压缩">头部压缩</h2>
<ul>
<li><strong>头部压缩</strong>：如果同时发出多个请求，而其Header是一样或相似的，则协议会帮助消除重复的部分</li>
<li><strong>原理-HPACK算法</strong>：客户端和服务器同时维护一张头信息表，所有字段都会存入这个表并生成一个索引号，以后则不发送同样字段，而是只发送索引号，提高了速度</li>
</ul>
<h2 id="二进制格式">二进制格式</h2>
<ul>
<li><strong>二进制格式</strong>：HTTP/2不再使用纯文本形式的报文，而是采用二进制格式，头部和数据体都是二进制，分别称为header
frame和data frame</li>
<li><strong>优点</strong>：接收方收到报文后，直接解析二进制报文，增加了数据传输效率</li>
</ul>
<h2 id="数据流">数据流</h2>
<ul>
<li><strong>编号</strong>：HTTP/2的每个请求或响应的所有数据包称为一个数据流（Stream），每个<strong>数据流都有唯一的编号</strong></li>
<li><strong>顺序</strong>：数据包不是按顺序发送，同一个连接里的数据包可能属于不同的响应</li>
</ul>
<h2 id="多路复用">多路复用</h2>
<ul>
<li><strong>并发</strong>：HTTP/2可以在一个连接中并发多个请求或响应，不用按顺序一一对应，<strong>解决了队头阻塞问题</strong></li>
</ul>
<h2 id="服务器推送">服务器推送</h2>
<ul>
<li><strong>服务器推送</strong>：浏览器刚请求html时，服务器提前把可能用到的js、css文件等静态资源主动发给客户端</li>
</ul>
<h1 id="http3">HTTP/3</h1>
<h2 id="http2尚存问题">HTTP/2尚存问题</h2>
<ul>
<li><strong>HTTP/1.1的阻塞</strong>：管道传输中的<strong>队头阻塞</strong>，即一个请求阻塞，队列后的请求也统统被阻塞</li>
<li><strong>HTTP/2的阻塞</strong>：多个HTTP请求复用一个TCP连接，一旦发生<strong>丢包</strong>则会触发TCP重传机制，一个TCP连接中的所有HTTP请求都必须等待这个丢了的包被重传回来</li>
</ul>
<h2 id="quic协议">QUIC协议</h2>
<ul>
<li><p><strong>UDP</strong>：HTTP/3的下层使用UDP协议，而不是TCP协议，同时通过基于UDP的QUIC协议实现了类似TCP的可靠传输</p></li>
<li><p><strong>可靠传输</strong>：QUIC实现的可靠传输机制，在某个流发生丢包时，只阻塞这个流，而不会阻塞其他流</p></li>
<li><p><strong>TLS协议版本</strong>：使用TLS1.3</p></li>
<li><p><strong>头部压缩算法</strong>：使用QPack算法</p></li>
<li><p><strong>QUIC三次握手</strong>：HTTPS建立连接时，需要进行TCP三次握手和TLS/1.3的三次握手共<strong>六次握手</strong>，而QUIC将握手过程合并，只需要进行QUIC三次握手</p></li>
</ul>
<h1 id="tcp">TCP</h1>
<h2 id="三次握手">三次握手</h2>
<h3 id="三次握手的详细过程">三次握手的详细过程</h3>
<ul>
<li>客户端发送SYN报文段</li>
<li>服务器回复SYN + ACK报文段</li>
<li>客户端发送ACK报文段</li>
</ul>
<h3 id="为什么不能是两次握手">为什么不能是两次握手</h3>
<ul>
<li><strong>防止历史连接初始化连接</strong>：客户端发送的第一个SYN报文段由于网络拥塞暂时未到达服务器，它又发起了第二个TCP连接，此时服务器收到第一个连接的SYN报文段，并返回SYN+ACK报文段，如果客户端该过期的SYN+ACK报文段，应该发送RST报文段终止该过期连接</li>
<li><strong>防止服务器资源浪费</strong>：若只需两次握手即建立TCP连接，则服务器收到SYN报文段后就建立连接。如果客户端SYN阻塞，则它可能建立多次SYN报文，那么服务器在收到请求后就会建立多个冗余的无效连接，造成资源浪费</li>
</ul>
<h3 id="为什么不是四次握手">为什么不是四次握手</h3>
<ul>
<li><strong>减少通信次数</strong>：可以使用四次握手，即客户端发送SYN，服务器回复ACK，服务器发送SYN，客户端回复ACK，但是可以将服务器发送的SYN与ACK合并为SYN
+ ACK报文段，从而减少通信次数</li>
</ul>
<h3 id="为什么客户端和服务端的初始序列号isn不同">为什么客户端和服务端的初始序列号ISN不同</h3>
<ul>
<li><strong>分辨历史报文</strong>：通信双方能根据序号将不属于本连接的报文段丢弃</li>
<li><strong>安全性</strong>：防止黑客伪造相同序列号的TCP报文段被对方接收</li>
</ul>
<h3 id="ip层会进行分片为什么tcp层还需要mss">IP层会进行分片，为什么TCP层还需要MSS？</h3>
<ul>
<li><strong>MTU</strong>：物理层帧的最大数据长度，对于以太网为1500字节，包含IP头部、TCP头部和TCP数据</li>
<li><strong>MSS</strong>：TCP数据段的最大长度</li>
<li><strong>IP分片</strong>：如果IP层有超过MTU大小的数据要发送，则IP层会对其分片，使得每一分片都小于MTU，目标主机的IP层将分片进行重新组装后再交给TCP</li>
<li><strong>IP分片丢失</strong>：若一个IP分片丢失，则整个IP数据报的所有分片都要重传，<strong>效率较低</strong></li>
<li>因此，TCP层发现数据超过MSS，则先对数据进行分片，保证IP数据报长度不超过MTU，从而避免了IP分片</li>
</ul>
<h3 id="syn攻击是什么如何避免">SYN攻击是什么？如何避免</h3>
<ul>
<li><p><strong>SYN攻击</strong>：TCP连接建立需要三次握手，若攻击者短时间伪造不同IP地址的SYN报文，服务端收到后进入SYN_RCVD状态，并发送SYN+ACK报文段，但该报文段无法得到未知IP地址主机的ACK应答，从而导致这些报文段占满服务端的SYN接收队列，服务器无法正常提供服务</p></li>
<li><p><strong>避免SYN攻击方式一</strong>：设置SYN_RCVD状态连接的最大个数，超出处理能力时，服务器对于新的SYN将直接回复RST报文段以丢弃该连接</p></li>
</ul>
<h4 id="linux的syn队列和accept队列">Linux的SYN队列和Accept队列</h4>
<ul>
<li><p><strong>SYN队列</strong>：收到客户端的SYN报文后，将连接加入SYN队列</p></li>
<li><p><strong>Accpet队列</strong>：发送SYN+ACK报文段，等待客户端回应ACK报文段，收到ACK报文段后，将连接从SYN队列移除，加入Accept队列</p></li>
<li><p><strong>应用调用</strong>：应用通过调用<code>accept()</code>socket接口，从Accept队列取出连接</p></li>
<li><p><strong>Accept队列占满</strong>：如果应用程序过慢，会导致Accept队列被占满</p></li>
<li><p><strong>SYN队列被占满</strong>：不断受到SYN攻击，会导致SYN队列被占满</p></li>
<li><p><strong>避免SYN攻击方式二</strong>：当SYN队列满之后，后续服务器收到SYN包，不进入SYN队列，而是计算一个cookie值作为SYN+ACK报文段的序列号返回客户端，收到客户端的ACK报文段后，讲检查其ACK的合法性，若合法则将该连接直接放入Accept队列</p></li>
</ul>
<h2 id="四次挥手">四次挥手</h2>
<h3 id="四次挥手过程和状态变迁">四次挥手过程和状态变迁</h3>
<ul>
<li>客户端发送FIN报文段，并进入FIN_WAIT1状态</li>
<li>服务器回复ACK报文段，进入CLOSE_WAIT状态、</li>
<li>客户端收到服务器对FIN报文段的ACK，进入FIN_WAIT2状态</li>
<li>服务器处理完已发送的报文段后，发送FIN报文段，进入LAST_ACK状态</li>
<li>客户端收到服务端的FIN报文段，回复ACK报文段，进入TIME_WAIT状态</li>
<li>服务器收到ACK报文段，关闭连接并进入CLOSED状态</li>
<li>客户端在2MSL时间内未收到服务器重传的FIN报文段，断开连接并进入CLOSED状态</li>
</ul>
<h3 id="为什么需要四次挥手">为什么需要四次挥手</h3>
<ul>
<li>客户端和发送方都需要发送FIN报文段，并对对方的FIN报文段回复ACK报文段</li>
<li>而且服务段发送ACK报文段与FIN报文段无法合并，因为通常它需要处理完所有需要发送的报文段后，才能发送FIN报文段</li>
</ul>
<h3 id="为什么time_wait等待的时间是2msl">为什么TIME_WAIT等待的时间是2MSL</h3>
<ul>
<li><p><strong>MSL</strong>：maximum segment
lifetime，报文最大生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃</p></li>
<li><p><strong>等待2MSL</strong>：TIME_WAIT等待2MSL，是因为如果报文段从发送方到接收方最多需要1MSL，接收方回复的报文段到达发送方最多需要1MSL，因此一来一回为2MSL</p></li>
<li><p><strong>重新计时</strong>：若在等待时间内，客户端收到了服务端重传的FIN报文段，则客户端再次发送ACK报文段，且2MSL将重新计时</p></li>
<li><p><strong>Linux系统的MSL</strong>：2MSL默认是60秒，即1MSL是30秒，Linux系统停留在TIME_WAIT的时间为固定的60秒</p></li>
</ul>
<h3 id="为什么需要time_wait状态">为什么需要TIME_WAIT状态</h3>
<ul>
<li><strong>防止旧连接的数据包</strong>：经过2MSL，网络中阻塞的数据包都肯定被丢弃，这样此后同一客户端、服务端在之前的端口号再次发起TCP连接，也不会被上一连接的旧数据包所干扰</li>
<li><strong>保证连接正确关闭</strong>：保证被动关闭连接的一方能够被正确地关闭，即保证最后的ACK能让被动关闭方接收，从而帮助其正常关闭。否则，服务端会一直处于LAST_ACK状态，此时任何客户端向其发起连接，服务段都会回复RST报文段</li>
</ul>
<h3 id="time_wait过多有何危害">TIME_WAIT过多有何危害</h3>
<h4 id="客户端受端口资源限制">客户端受端口资源限制</h4>
<ul>
<li><strong>内存资源占用</strong></li>
<li><strong>端口资源占用</strong>：一个TCP连接至少消耗一个本地端口，如果发起连接一方的TIME_WAIT状态过多，占满了所有端口资源，将导致无法创建新连接</li>
</ul>
<h4 id="服务端受系统资源限制">服务端受系统资源限制</h4>
<ul>
<li>一个TCP连接由四元组标识，理论上服务端可以建立很多连接，它只监听一个端口，并把连接交给处理线程。但由于线程池也无法处理大量的连接，所以服务端出现大量TIME_WAIT时，系统资源被耗尽</li>
</ul>
<h3 id="如果建立连接后客户端故障怎么办">如果建立连接后，客户端故障怎么办？</h3>
<ul>
<li><strong>TCP保活机制</strong>：如果一个时间段内，没有任何连接相关的活动，则启动TCP保活机制。每隔一个时间间隔发送一个探测报文，若连续几个探测报文都没有得到响应，则认为当前的TCP连接已死亡，系统内核将错误信息通知上层应用程序</li>
<li>TCP保活机制的可能情况
<ul>
<li><strong>对端正常工作</strong>，则探测报文能够得到对端正常响应，TCP保活时间被重置</li>
<li><strong>对端崩溃并重启</strong>，此时对端收到探测报文后，将回复RST报文段</li>
<li><strong>对端崩溃或由于其他原因导致报文不可达</strong>，则TCP连续重传探测报文后，将报告该TCP连接已死亡</li>
</ul></li>
</ul>
<h2 id="重传机制">重传机制</h2>
<h3 id="超时重传">超时重传</h3>
<ul>
<li><p><strong>含义</strong>：发送数据时，设定一个定时器，当超过指定时间后，没有收到对方的ACK确认应答报文，就会重发该数据，即超时重传</p></li>
<li><p><strong>原因</strong>：发送方发送的报文段丢失，或接收方回复的应答报文丢失，都可能导致超时重传</p></li>
<li><p><strong>超时时间RTO的设置</strong></p>
<p><strong>RTT</strong>：RTO大小至少为RTT往返时延，即数据从网络一端传送到另一端，并收到另一端的确认应答的时间，即包的<strong>往返时间</strong></p>
<p><strong>RTO设置过大</strong>：重传太慢，效率低，性能差</p>
<p><strong>RTO设置过小</strong>：在没有丢包的情况下就重发，增加了冗余报文，加剧网络拥塞</p>
<p><strong>Linux计算RTO的方法</strong></p>
<ul>
<li><strong>采样RTT时间</strong>，并进行加权平均得到平滑RTT的值</li>
<li><strong>采样RTT的波动范围</strong>，当RTT变化较大时需要增加RTO的值</li>
</ul>
<p><strong>超时重传时RTO的变化</strong>，当发生超时重传时，TCP将RTO加倍，即在网络拥塞的情况下允许更长的等待时间</p></li>
</ul>
<h3 id="快速重传">快速重传</h3>
<ul>
<li><strong>冗余ACK</strong>：接收方对于之前已经确认过的报文段，进行了重复的确认，原因是因为接收方收到了一个乱序的报文，而并未收到所期望的下一个报文</li>
<li><strong>快速重传</strong>：当发送方接收到三个相同的冗余ACK报文时，会立刻重传当前第一个未确认的报文段，而无需等待定时器中断</li>
</ul>
<h3 id="sack方法选择性确认">SACK方法（选择性确认）</h3>
<ul>
<li><strong>SACK</strong>：接收方在TCP头部选项字段加入SACK，将接收缓存的map发送给发送方，发送方从SACK获取哪些数据没收到，只重传丢失的数据</li>
</ul>
<h3 id="d-sack方法duplicate-sack">D-SACK方法（Duplicate SACK）</h3>
<ul>
<li>使用SACK告诉发送方有哪些数据被重复接收了，发送方能根据SACK判断出这些重复接收的报文的ACK报文丢失了，无需重传</li>
</ul>
<h2 id="流量控制">流量控制</h2>
<ul>
<li><p><strong>窗口大小限制发送速率</strong>：发送方无需等待确认应答，可以继续发送数据的最大值</p></li>
<li><p><strong>窗口大小的决定</strong>：TCP首部包含接收窗口字段，<strong>接收方根据自己的缓冲区还能接收多少数据决定</strong>，告诉发送方接收窗口大小</p></li>
<li><p><strong>接收窗口大小为0</strong>：此时发送方仍然需要发送报文段（<strong>窗口探测报文</strong>）并携带1字节数据，这是为了从接收方回复的应答报文中，获取接收窗口大小的变化，否则发送方将一直认为接收窗口为0而不发送报文</p></li>
</ul>
<h2 id="拥塞控制">拥塞控制</h2>
<ul>
<li><strong>慢启动</strong>：拥塞窗口cwnd为1，表示可以发送一个携带MSS字节数据的报文段，每接收1个ACK则cwnd就增加1。当不断增长直至发生超时，则将慢启动阈值设为cwnd/2，并进入拥塞避免状态</li>
<li><strong>拥塞避免</strong>：拥塞窗口cwnd设为慢启动阈值，此后每接收1个ACK则cwnd增加1/cwnd</li>
<li><strong>快速恢复</strong>：当发送方收到3个重复的冗余ACK报文，则进行快速重传，将慢启动阈值设为cwnd/2，cwnd设为慢启动阈值
+
3。快速恢复阶段中，每收到1个冗余ACK则cwnd增加1，若收到一个新的有效ACK，则恢复拥塞避免状态</li>
</ul>
<h1 id="ip协议">IP协议</h1>
<ul>
<li><p><strong>网络层</strong>和<strong>数据链路层</strong>之间的区别和联系</p>
<p>MAC的作用是实现<strong>直连</strong>的两个设备之间的通信，而IP则负责在<strong>没有直连</strong>的两个网络之间进行通信传输</p>
<p>MAC负责<strong>某一个区间</strong>之内的通信传输，而IP负责将数据包发给最终的目的地址</p>
<p>在此过程中，源MAC地址和目标MAC地址一直在<strong>变化</strong>，而源IP地址和目标IP地址在传输过程中<strong>不会改变</strong></p></li>
</ul>
<h2 id="ip地址的分类">IP地址的分类</h2>
<ul>
<li><p><strong>分类</strong>：IP地址划分为5种类型，分别是A类、B类、C类、D类、E类</p>
<p>A类以0开头，地址范围为0.0.0.0-127.255.255.255</p>
<p>B类以10开头，地址范围为128.0.0.0-191.255.255.255</p>
<p>C类以110开头，地址范围为192.0.0.0-223.255.255.255</p>
<p>D类以1110开头，地址范围为224.0.0.0-239.255.255.255</p>
<p>E类以1111开头，地址范围为240.0.0.0-255.255.255.255</p></li>
<li><p><strong>广播地址</strong></p>
<p><strong>主机号全为0</strong>指定某个网络</p>
<p><strong>主机号全为1</strong>指定某个网络下的所有主机，用于广播</p>
<p>广播地址用于在同一个链路中相互连接的主机之间发送数据包</p></li>
<li><p>分类地址的<strong>缺点</strong></p>
<p>同一网络下<strong>没有地址层次</strong></p>
<p>不能很好地与现实网络匹配，因为C类地址只包含254个主机数量，而B类地址包含65534个主机，容易造成<strong>地址浪费</strong></p></li>
</ul>
<h2 id="cidr无分类地址">CIDR无分类地址</h2>
<ul>
<li><strong>网络号+主机号</strong>，32位的IP地址划分为网络号和主机号，<code>a.b.c.d/x</code>，其中<code>/x</code>表示前x位为网络号，x的范围为0-32</li>
<li><strong>子网掩码</strong>：掩盖掉主机号，将IP地址和子网掩码按位相与即可得到网络号，因此子网掩码的高x位为1，低位为0</li>
<li><strong>广播地址</strong>：网络号 + 主机号全为1的地址</li>
</ul>
<h3 id="网络号和主机号分离的原因">网络号和主机号分离的原因</h3>
<ul>
<li><strong>直接交付</strong>：两台计算机通讯，首先应判断是否处于同一个广播域内，若网络号相同，则接收方在本网络上，可以把数据包直接发送到目标主机</li>
</ul>
<h3 id="子网划分">子网划分</h3>
<ul>
<li><p><strong>子网划分</strong>：将主机地址划分为两个部分，子网网络地址和子网主机地址</p>
<p><strong>未做子网划分的IP地址</strong>：网络地址 + 主机地址</p>
<p><strong>做了子网划分的IP地址</strong>：网络地址 + 子网网络地址 +
子网主机地址</p></li>
</ul>
<h2 id="公有ip地址和私有ip地址">公有IP地址和私有IP地址</h2>
<ul>
<li>A、B、C分类地址中，实际上有公有IP地址和私有IP地址</li>
<li><strong>私有IP地址</strong>允许组织内部的IT人员自己管理、自己分配，且<strong>可以重复</strong>，如学校、办公室使用的IP地址常为私有IP地址</li>
<li><strong>公有IP地址</strong>在整个互联网范围内保持<strong>唯一</strong>，由<strong>ICANN</strong>组织统一管理，称为互联网名称与数字地址分配机构</li>
</ul>
<h2 id="ip地址与路由控制">IP地址与路由控制</h2>
<ul>
<li><strong>路由控制表</strong>：网络地址用于进行路由控制，路由控制表记录着网络地址与下一步应该发送到的路由器地址</li>
<li><strong>路由器转发</strong>：根据IP包首部中的目标IP地址，在路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给响应的下一个路由器</li>
<li><strong>最长匹配</strong>：如果路由控制表中存在多条相同网络地址的记录，就选择相同位数最多的网络地址</li>
</ul>
<h3 id="默认路由">默认路由</h3>
<ul>
<li><strong>默认路由</strong>：如果路由控制表中没有找到匹配的项，则数据包被转发到默认路由</li>
</ul>
<h3 id="环回地址">环回地址</h3>
<ul>
<li><strong>环回地址</strong>：在同一台计算机上的程序之间进行网络通信时，使用环回地址，即127.0.0.1。使用环回地址时，数据包不会流向网络</li>
</ul>
<h2 id="ip分片与重组">IP分片与重组</h2>
<ul>
<li><strong>MTU</strong>：数据链路的最大传输单元，如以太网MTU是1500字节，且不同数据链路的MTU常常不同</li>
<li><strong>IP分片</strong>：若IP数据报的大小大于MTU，则会由路由器进行分片，而重组则由目标主机进行</li>
<li><strong>IP分片丢失</strong>：某个分片丢失，将会导致整个IP数据报重传。为此，TCP引入了MSS，在运输层进行分片而不是IP层分片，则某个分组丢失只需要重传该分组即可。对于UDP，尽量不要发送一个大于MTU的数据报文</li>
</ul>
<h2 id="ipv6">IPv6</h2>
<ul>
<li><p>优点</p>
<p><strong>自动配置</strong>，即使没有DHCP服务器也可以实现自动分配IP地址</p>
<p><strong>首部长度固定</strong>为40字节</p>
<p><strong>安全性</strong>提高，具有应对伪造IP地址、防止线路窃听等功能</p></li>
<li><p>标识方法</p>
<p>IPv6地址长度为128位，每16位为1组，共8组，用冒号分隔</p></li>
</ul>
<h1 id="重要协议">重要协议</h1>
<h2 id="dns">DNS</h2>
<ul>
<li><p><strong>域名解析功能</strong>：将域名网址转换为具体的IP地址</p></li>
<li><p><strong>域名的层级关系</strong>：根DNS服务器、顶级域DNS服务器、权威DNS服务器</p></li>
<li><p>域名解析流程</p>
<p>查看<strong>浏览器缓存</strong></p>
<p>查看<strong>操作系统缓存</strong></p>
<p>查看<strong>本机域名解析文件hosts</strong></p>
<p>若均未查到则向<strong>DNS服务器</strong>进行查询：本地DNS服务器（递归查询）、根DNS服务器（迭代查询）、顶级域DNS服务器（迭代）、权威DNS服务器（迭代）</p></li>
</ul>
<h2 id="arp">ARP</h2>
<ul>
<li><p><strong>功能</strong>：根据IP地址获取MAC地址</p></li>
<li><p><strong>ARP协议</strong></p>
<p><strong>ARP请求报文</strong>：将IP地址放入ARP请求，广播发送ARP请求</p>
<p><strong>ARP响应报文</strong>：同一链路的所有设备收到ARP请求时，会比对其中的IP地址与自己的IP地址，若匹配则将自己的MAC地址放入ARP响应报文并返回</p>
<p><strong>操作系统缓存</strong>：操作系统会将ARP获取的MAC地址缓存起来，该缓存有一定期限</p></li>
<li><p><strong>RARP协议</strong>：已知MAC地址，求IP地址</p></li>
</ul>
<h2 id="dhcp">DHCP</h2>
<ul>
<li><p>动态主机配置协议</p>
<p><strong>DHCP
discover报文</strong>：客户端发送DHCP发现报文，由于此时客户端没有IP地址，也不知道DHCP服务器地址，因此目的IP地址设为广播地址255.255.255.255:
67，源地址为0.0.0.0: 68</p>
<p><strong>DHCP offer报文</strong>：DHCP服务器收到DHCP发现报文后，用DHCP
offer报文响应，仍然使用IP广播地址，其中携带可租约的IP地址、子网掩码、默认网关、DNS服务器以及IP地址租用期等</p>
<p><strong>DHCP request报文</strong>：客户端可能收到多个服务器的DHCP
offer报文，从中选择一个，并向选中的服务器发送DHCP请求报文响应，回显配置的参数</p>
<p><strong>DHCP ACK报文</strong>：最后服务器用DHCP
ACK报文进行响应，应答所要求的参数</p></li>
<li><p><strong>DHCP中继代理</strong>：现实中并非每个子网都有一个DHCP服务器，使用DHCP中继代理解决。中继代理收到DHCP发现报文后，以单播的形式将其发送给DHCP服务器，DHCP服务器返回DHCP
offer报文给中继代理，中继代理将该offer报文广播，以发送给DHCP客户端</p></li>
</ul>
<h2 id="nat">NAT</h2>
<ul>
<li><p><strong>网络地址转换</strong>：将私有IP地址转换为公有IP地址</p></li>
<li><p><strong>网络地址与端口转换</strong>，将<strong>IP地址 +
端口号</strong>一起进行转换</p>
<ul>
<li>如某个家庭子网的公有IP地址为120.299.175.121，其主机A具有私有IP地址192.168.1.10、主机B具有私有IP地址192.168.1.11</li>
<li>主机A端口1025和主机B端口1025与远程服务器进行通信，则NAT将其都转换为公有IP地址120.299.175.121，并以<strong>不同的端口号进行区分</strong></li>
<li>NAT路由器转换表</li>
</ul>
<table>
<thead>
<tr class="header">
<th>私有IP地址</th>
<th>公有IP地址</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>192.168.1.10:1025</td>
<td>120.299.175.121:1025</td>
</tr>
<tr class="even">
<td>192.168.1.11:1025</td>
<td>120.299.175.121:1026</td>
</tr>
</tbody>
</table></li>
<li><p><strong>NAT缺点</strong></p>
<p>NAT转换表的生成，转换操作本身都会产生<strong>性能开销</strong></p>
<p>若<strong>NAT路由器重启</strong>，则所有TCP连接都将重置</p></li>
</ul>
<h2 id="icmp">ICMP</h2>
<ul>
<li><p><strong>名称</strong>：互联网控制报文协议</p></li>
<li><p><strong>功能</strong>：确认IP数据报是否成功送达目标地址、报告发送过程中IP数据报被丢弃的原因、改善网络设置等</p></li>
<li><p>类型</p>
<p><strong>查询报文类型</strong>：用于诊断的查询消息</p>
<p><strong>差错报文类型</strong>：通知出错原因的错误消息</p></li>
</ul>
<h1 id="ping的工作原理">ping的工作原理</h1>
<h2 id="icmp协议">ICMP协议</h2>
<ul>
<li><p><strong>功能</strong></p>
<p>报告IP数据报是否送达目的地址</p>
<p>报告IP数据报被丢弃的原因</p>
<p>改善网络设置</p></li>
<li><p>ICMP报文格式</p>
<p>ICMP报文封装在<strong>IP数据报</strong>，工作在网络层</p></li>
<li><p>类型</p>
<p><strong>查询报文类型</strong>：用于诊断的查询消息，包括</p>
<ul>
<li>0 <strong>回送应答</strong></li>
<li>8 <strong>回送请求</strong></li>
</ul>
<p><strong>差错报文类型</strong>：通知出错原因，包括</p>
<ul>
<li>3
<strong>目标不可达</strong>，又可细分为：网络不可达、主机不可达、协议不可达、端口不可达、需要进行分片但设置了不分片位</li>
<li>4 <strong>原点抑制</strong>，为了缓解网络拥堵</li>
<li>5
<strong>重定向或改变路由</strong>，路由器发现发送端主机使用了非最优路径发送数据时，通过ICMP重定向消息告知主机最合适的路由信息</li>
<li>11
<strong>超时</strong>，当IP数据报的<strong>TTL字段变为0时</strong>该IP数据报将被丢弃，路由器发送ICMP超市消息给发送端主机</li>
</ul></li>
</ul>
<h2 id="ping查询报文类型的使用">ping—查询报文类型的使用</h2>
<ul>
<li><p>ICMP报文字段</p>
<p><strong>类型字段</strong>：0或8</p>
<p><strong>标识符</strong>：区分哪个应用程序发送ICMP包，如用进程PID作为标识符</p>
<p><strong>序号</strong>：每发送一个新的ICMP回送请求则递增</p>
<p><strong>选项</strong>：常存放发送请求的时间值，用于计算往返时间</p></li>
<li><p><strong>ICMP回送请求</strong>：源主机生成ICMP回送请求消息，包含<strong>类型字段为8</strong>、序号字段、发送时间等，并交给IP层发送给目的主机</p></li>
<li><p><strong>ICMP回送响应</strong>：目的主机构建ICMP回送响应消息数据包，包含<strong>类型字段为0</strong>、序号字段（与接收的ICMP回送请求序号一致），并交付给IP层发送给源主机</p></li>
<li><p><strong>是否可达</strong>：规定时间内，源主机收到ICMP回送响应，则目标主机可达；否则，目标主机不可达</p></li>
<li><p><strong>往返时延</strong>：源主机利用发送时间和接收时间可以计算往返时延RTT</p></li>
</ul>
<h2 id="traceroute差错报文类型的使用">traceroute—差错报文类型的使用</h2>
<h3 id="作用一追踪去往目的地时沿途经过的路由器">作用一：追踪去往目的地时沿途经过的路由器</h3>
<ul>
<li>发送端主机不断发送UDP报文段，设置端口号为不可能的端口号，IP数据包的<strong>TTL从1</strong>开始不断递增</li>
<li>若未达到目的主机将返回<strong>ICMP超时消息</strong>，若达到主机将返回<strong>ICMP端口不可达消息</strong></li>
</ul>
<h3 id="作用二确定路径的mtu">作用二：确定路径的MTU</h3>
<ul>
<li><strong>设置分片禁止标志位</strong>：发送端主机发送IP数据报时，将IP首部的分片禁止标志位设置为1，则沿途的路由器在需要进行分片时不会对IP数据报进行分片，而是直接丢弃</li>
<li><strong>ICMP不可达消息</strong>：通过ICMP不可达消息将数据链路上<strong>MTU的值</strong>返回给发送主机</li>
<li><strong>调整包大小</strong>：发送主机端收到ICMP不可达消息后即调整包的大小，最终得到能到达目标主机的合适的MTU</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Young</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
